<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIFO - Ë¶≥ÂÖâÁå´ÂûãAI„Ç¢„Éâ„Éê„Ç§„Ç∂„É™„Éº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tifo-bg: #F7FAFC;
            --tifo-text: #2D3748;
            --tifo-primary: #4FD1C5;
            --tifo-primary-dark: #38B2AC;
            --tifo-card-border: #E2E8F0;
            --tifo-card-bg: #FFFFFF;
            /* Áúå„ÅÆ„Ç´„É©„Éº„Ç≥„Éº„Éâ */
            --color-toyama-bg: #4db56a;
            --color-ishikawa-bg: #008cbe;
            --color-fukui-bg: #00006b;
            --color-pref-text: #ffffff;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--tifo-bg);
            color: var(--tifo-text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main#app-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .tifo-card {
            background-color: var(--tifo-card-bg);
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--tifo-card-border);
        }
        .tifo-button {
            background-color: var(--tifo-primary);
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            border-bottom: 4px solid var(--tifo-primary-dark);
            transition: all 0.2s ease;
        }
        .tifo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -3px rgba(79, 209, 197, 0.4);
        }
        .tifo-button:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }
        /* „Å§„Å∂„ÇÑ„Åç„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
        .tifo-button-secondary {
            background-color: #fff;
            color: var(--tifo-primary);
            border: 2px solid var(--tifo-primary);
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            transition: all 0.2s ease;
        }
        .tifo-button-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -3px rgba(79, 209, 197, 0.2);
        }

        .prefecture-btn {
            background-color: var(--tifo-card-bg);
            color: var(--tifo-primary-dark);
            font-weight: bold;
            padding: 0.5rem 1.25rem;
            border-radius: 9999px;
            border: 2px solid var(--tifo-card-border);
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        .prefecture-btn:hover {
            transform: translateY(-2px);
            border-color: var(--tifo-primary);
            box-shadow: 0 6px 12px -3px rgba(79, 209, 197, 0.3);
        }
        .tab-button {
            padding: 0.75rem 1rem;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #A0AEC0;
            transition: all 0.2s ease;
        }
        .tab-button:hover {
            background-color: #F7FAFC;
            color: #4A5568;
        }
        .tab-button.active {
            color: var(--tifo-primary);
            border-bottom-color: var(--tifo-primary);
        }
        .rank-badge {
            width: 2.25rem; height: 2.25rem; border-radius: 50%; display: inline-flex;
            align-items: center; justify-content: center; font-weight: bold; color: white;
            flex-shrink: 0; font-size: 1rem;
        }
        .rank-1 { background-color: #FFD700; }
        .rank-2 { background-color: #C0C0C0; }
        .rank-3 { background-color: #CD7F32; }
        .rank-default { background-color: #A9A9A9; }
        
        .pref-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 9999px;
        }
        .pref-toyama { background-color: var(--color-toyama-bg); color: var(--color-pref-text); }
        .pref-ishikawa { background-color: var(--color-ishikawa-bg); color: var(--color-pref-text); }
        .pref-fukui { background-color: var(--color-fukui-bg); color: var(--color-pref-text); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 1rem; max-width: 90%; width: 700px; max-height: 80vh; overflow-y: auto; }

        /* MarkdownË°®Á§∫Áî®„Çπ„Çø„Ç§„É´ */
        .markdown-body h1 { font-size: 1.75rem; font-weight: bold; color: var(--tifo-primary); border-bottom: 2px solid var(--tifo-card-border); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .markdown-body h2 { font-size: 1.5rem; font-weight: bold; margin-top: 2rem; margin-bottom: 1rem; padding-left: 0.75rem; border-left: 4px solid var(--tifo-primary); color: var(--tifo-text); }
        .markdown-body h3 { font-size: 1.25rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #4A5568; }
        .markdown-body hr { border-top: 1px solid var(--tifo-card-border); margin: 2rem 0; }
        .markdown-body ul { list-style: none; padding-left: 0; margin: 1rem 0; }
        .markdown-body li { background-color: #F7FAFC; border-radius: 0.5rem; padding: 0.75rem 1rem; margin-bottom: 0.5rem; position: relative; padding-left: 2rem; }
        .markdown-body li::before { content: 'üêæ'; position: absolute; left: 0.75rem; top: 0.75rem; color: var(--tifo-primary); }
        .markdown-body strong { color: var(--tifo-primary-dark); font-weight: bold; }
        .markdown-body p { margin-bottom: 1rem; line-height: 1.7; }
    </style>
</head>
<body class="text-gray-800">
    
    <div id="loading-indicator" class="min-h-screen flex flex-col items-center justify-center p-4 text-center">
        <p class="text-gray-600">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</p>
    </div>

    <main id="app-container" class="container mx-auto p-4 md:p-8 max-w-4xl hidden">
        <div id="intro-section">
            <!-- Header: Logo and Character -->
            <header class="flex items-center justify-center gap-4 mb-4 text-center">
                <a href="https://codefornoto.github.io/TIFO/" target="_blank" rel="noopener noreferrer">
                    <div class="w-24 h-24">
                        <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                            <path fill="var(--tifo-primary)" d="M47.9,-51.9C62.4,-41.2,74.7,-25.9,78.2,-8.1C81.7,9.7,76.4,30.1,64.8,44.2C53.2,58.3,35.3,66.1,17.7,70.8C0.1,75.5,-17.2,77.1,-33.1,70.2C-49,63.3,-63.5,47.9,-71.4,30.1C-79.3,12.3,-80.6,-7.8,-74.3,-24.1C-68,-40.4,-54.1,-52.9,-38.8,-60.1C-23.5,-67.3,-6.8,-69.2,8.9,-66.1C24.6,-63,47.9,-51.9,47.9,-51.9Z" transform="translate(100 100)"></path>
                            <text x="50%" y="55%" text-anchor="middle" dominant-baseline="middle" font-size="50" font-weight="bold" fill="white" letter-spacing="2">TIFO</text>
                        </svg>
                    </div>
                </a>
                <img src="tifo.png" alt="TIFO„Å°„ÇÉ„Çì" class="h-20 w-20 object-contain">
            </header>
            <p class="text-lg text-gray-600 mb-8 text-center">Ë¶≥ÂÖâÁå´ÂûãAI„Ç¢„Éâ„Éê„Ç§„Ç∂„É™„Éº</p>

            <!-- Prefecture Selection Buttons -->
            <section class="mb-8">
                <div class="flex items-center justify-center gap-4">
                    <button class="prefecture-btn">ÂØåÂ±±</button>
                    <a href="https://beeb-c4n.github.io/tifo/ishikawa/#" class="prefecture-btn" target="_blank" rel="noopener noreferrer">Áü≥Â∑ù</a>
                    <button class="prefecture-btn">Á¶è‰∫ï</button>
                </div>
            </section>

            <!-- Action Buttons -->
            <section class="text-center mb-8 space-y-4">
                <button id="analysis-btn" class="tifo-button text-lg px-8">
                    ÔºìÁúåÈÄ£Êê∫„Éá„Éº„ÇøÂàÜÊûê
                </button>
                <br>
                <button id="insights-btn" class="tifo-button-secondary text-md px-6">
                    Tifo„Å°„ÇÉ„Çì„ÅÆ„Å§„Å∂„ÇÑ„Åç
                </button>
            </section>
        </div>
        <!-- Analysis Results Area -->
        <div id="analysis-results" class="hidden space-y-8">
            <section class="tifo-card">
                <div class="flex border-b border-gray-200 mb-4">
                    <button id="nps-tab" class="tab-button active">NPS</button>
                    <button id="satisfaction-tab" class="tab-button">ÊñΩË®≠ÂÖ®‰ΩìÊ∫ÄË∂≥Â∫¶</button>
                </div>
                <div id="ranking-container" class="custom-scrollbar h-96 overflow-y-auto pr-2 space-y-3"></div>
            </section>
            <section class="tifo-card">
                <h2 class="text-xl font-bold mb-4 border-b border-gray-200 pb-3" style="color: var(--tifo-primary-dark);">„Çª„Ç∞„É°„É≥„ÉàÂà•„É©„É≥„Ç≠„É≥„Ç∞</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <select id="category-filter" class="w-full p-2.5 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-teal-400 focus:border-teal-400">
                        <option selected value="">ÂàÜÊûêËª∏„ÇíÈÅ∏Êäû...</option>
                        <option value="age">Âπ¥‰ª£</option>
                        <option value="gender">ÊÄßÂà•</option>
                        <option value="stay">ÂÆøÊ≥äÊï∞</option>
                        <option value="companion">Âêå‰º¥ËÄÖ</option>
                        <option value="purpose">ÊóÖ„ÅÆÁõÆÁöÑ</option>
                        <option value="prefecture">ÈÉΩÈÅìÂ∫úÁúå</option>
                    </select>
                    <select id="detail-filter" class="w-full p-2.5 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-teal-400 focus:border-teal-400" disabled>
                        <option selected value="">Ë©≥Á¥∞„ÇíÈÅ∏Êäû...</option>
                    </select>
                </div>
                <div id="segment-ranking-container" class="custom-scrollbar h-96 overflow-y-auto pr-2 space-y-3">
                     <p class="text-gray-500 text-center pt-10">„ÅØ„Åò„ÇÅ„Å´ÂàÜÊûêËª∏„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="w-full p-4">
         <div class="text-center">
            <button id="about-button" class="text-sm text-gray-500 hover:underline">TIFO„Å®„ÅØ</button>
        </div>
    </footer>
    
    <!-- About Modal -->
    <div id="about-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">TIFO„Å®„ÅØ</h2>
            <div id="about-text" class="text-sm text-gray-600 leading-relaxed space-y-2"></div>
            <button id="close-about-modal-button" class="tifo-button mt-6 w-full">Èñâ„Åò„Çã</button>
        </div>
    </div>
    
    <!-- Insights Modal -->
    <div id="insights-modal" class="modal-overlay hidden">
        <div class="modal-content custom-scrollbar">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Tifo„Å°„ÇÉ„Çì„ÅÆ„Å§„Å∂„ÇÑ„Åç</h2>
                <button id="close-insights-modal-button" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            <div id="insights-text" class="markdown-body"></div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    let surveyData = [];
    const loadingIndicator = document.getElementById('loading-indicator');
    const appContainer = document.getElementById('app-container');

    const filterOptions = {
        age: ['10‰ª£','20‰ª£','30‰ª£','40‰ª£','50‰ª£','60‰ª£','70‰ª£','80‰ª£','90‰ª£','100‰ª£'],
        gender: ['Áî∑ÊÄß', 'Â•≥ÊÄß'],
        stay: ['1Ê≥ä', '2Ê≥ä', '3Ê≥ä', '4Ê≥ä‰ª•‰∏ä', 'Êó•Â∏∞„Çä'],
        companion: ['Ëá™ÂàÜ„Å≤„Å®„Çä','ÊÅã‰∫∫','Âèã‰∫∫','Â§´Â©¶2‰∫∫','Âõ£‰ΩìÊóÖË°å','Ë¶™Êàö','Ë¶™','ËÅ∑Â†¥„ÅÆÂêåÂÉö','Â∞èÂ≠¶Áîü‰ª•‰∏ãÈÄ£„Çå„ÅÆÂÆ∂Êóè','‰∏≠Â≠¶Áîü‰ª•‰∏ãÈÄ£„Çå„ÅÆÂÆ∂Êóè','È´òÊ†°ÁîüÈÄ£„Çå„ÅÆÂÆ∂Êóè','ÁÅΩÂÆ≥ÊîØÊè¥'],
        purpose: ['ÂÆø„Åß„ÅÆ„Çì„Å≥„ÇäÈÅé„Åî„Åô','Ê∏©Ê≥â„ÇÑÈú≤Â§©È¢®ÂëÇ','Âú∞ÂÖÉ„ÅÆÁæéÂë≥„Åó„ÅÑ„ÇÇ„ÅÆ„ÇíÈ£ü„Åπ„Çã','Ëä±Ë¶ã„ÇÑÁ¥ÖËëâ„Å™„Å©„ÅÆËá™ÁÑ∂ÈëëË≥û','ÂêçÊâÄ„ÄÅÊóßË∑°„ÅÆË¶≥ÂÖâ','„ÉÜ„Éº„Éû„Éë„Éº„ÇØÔºàÈÅäÂúíÂú∞„ÄÅÂãïÁâ©Âúí„ÄÅÂçöÁâ©È§®„Å™„Å©Ôºâ','Ë≤∑„ÅÑÁâ©„ÄÅ„Ç¢„Ç¶„Éà„É¨„ÉÉ„Éà','„ÅäÁ•≠„Çä„ÇÑ„Ç§„Éô„É≥„Éà„Å∏„ÅÆÂèÇÂä†„ÉªË¶ãÁâ©','„Çπ„Éù„Éº„ÉÑË¶≥Êà¶„ÇÑËä∏ËÉΩÈëëË≥ûÔºà„Ç≥„É≥„Çµ„Éº„ÉàÁ≠âÔºâ','„Ç¢„Ç¶„Éà„Éâ„Ç¢ÔºàÊµ∑Ê∞¥Êµ¥„ÄÅÈá£„Çä„ÄÅÁôªÂ±±„Å™„Å©Ôºâ','„Åæ„Å°„ÅÇ„Çã„Åç„ÄÅÈÉΩÂ∏ÇÊï£Á≠ñ','ÂêÑÁ®Æ‰ΩìÈ®ìÔºàÊâã‰Ωú„Çä„ÄÅÊûúÁâ©Áã©„Çä„Å™„Å©Ôºâ','„Çπ„Ç≠„Éº„Éª„Çπ„Éé„Éú„ÄÅ„Éû„É™„É≥„Çπ„Éù„Éº„ÉÑ','„Åù„ÅÆ‰ªñ„Çπ„Éù„Éº„ÉÑÔºà„Ç¥„É´„Éï„ÄÅ„ÉÜ„Éã„Çπ„Å™„Å©Ôºâ','„Éâ„É©„Ç§„Éñ„Éª„ÉÑ„Éº„É™„É≥„Ç∞','Âèã‰∫∫„ÉªË¶™Êàö„ÇíÂ∞ã„Å≠„Çã','Âá∫Âºµ„Å™„Å©‰ªï‰∫ãÈñ¢‰øÇ'],
        prefecture: ['ÂåóÊµ∑ÈÅì','ÈùíÊ£ÆÁúå','Â≤©ÊâãÁúå','ÂÆÆÂüéÁúå','ÁßãÁî∞Áúå','Â±±ÂΩ¢Áúå','Á¶èÂ≥∂Áúå','Ëå®ÂüéÁúå','Ê†ÉÊú®Áúå','Áæ§È¶¨Áúå','ÂüºÁéâÁúå','ÂçÉËëâÁúå','Êù±‰∫¨ÈÉΩ','Á•ûÂ•àÂ∑ùÁúå','Êñ∞ÊΩüÁúå','ÂØåÂ±±Áúå','Áü≥Â∑ùÁúå','Á¶è‰∫ïÁúå','Â±±Ê¢®Áúå','Èï∑ÈáéÁúå','Â≤êÈòúÁúå','ÈùôÂ≤°Áúå','ÊÑõÁü•Áúå','‰∏âÈáçÁúå','ÊªãË≥ÄÁúå','‰∫¨ÈÉΩÂ∫ú','Â§ßÈò™Â∫ú','ÂÖµÂ∫´Áúå','Â•àËâØÁúå','ÂíåÊ≠åÂ±±Áúå','È≥•ÂèñÁúå','Â≥∂Ê†πÁúå','Â≤°Â±±Áúå','Â∫ÉÂ≥∂Áúå','Â±±Âè£Áúå','Âæ≥Â≥∂Áúå','È¶ôÂ∑ùÁúå','ÊÑõÂ™õÁúå','È´òÁü•Áúå','Á¶èÂ≤°Áúå','‰ΩêË≥ÄÁúå','Èï∑Â¥éÁúå','ÁÜäÊú¨Áúå','Â§ßÂàÜÁúå','ÂÆÆÂ¥éÁúå','ÈπøÂÖêÂ≥∂Áúå','Ê≤ñÁ∏ÑÁúå']
    };
    
    // --- Function to parse CSV into an array of objects (Robust version) ---
    const parseCSV = (csvText) => {
        if (csvText.charCodeAt(0) === 0xFEFF) {
            csvText = csvText.slice(1);
        }
        const lines = csvText.trim().replace(/\r/g, '').split('\n');
        if (lines.length < 2) return [];

        const csvRegex = /(?:^|,)(?:"([^"]*(?:""[^"]*)*)"|([^,]*))/g;
        
        const parseLine = (line) => {
            const values = [];
            let match;
            csvRegex.lastIndex = 0;
            while (match = csvRegex.exec(line)) {
                let value = match[1] ? match[1].replace(/""/g, '"') : match[2];
                values.push(value);
            }
            return values;
        };

        const headers = parseLine(lines[0]);
        
        return lines.slice(1).map(line => {
            if (!line.trim()) return null;
            const values = parseLine(line);
            const entry = {};
            headers.forEach((header, index) => {
                const key = header.trim();
                const rawValue = (values[index] || '').trim();
                
                if (rawValue === '') {
                    entry[key] = null;
                } else {
                    const numValue = parseFloat(rawValue);
                    entry[key] = !isNaN(numValue) ? numValue : rawValue;
                }
            });
            if (entry['TIF']) {
                entry['Áúå'] = entry['TIF'];
                delete entry['TIF'];
            }
            return entry;
        }).filter(Boolean);
    };

    // --- Function to parse Markdown to HTML (Corrected Version) ---
    const parseMarkdown = (mdText) => {
        const lines = mdText.trim().replace(/\r/g, '').split('\n');
        let html = '';
        let inList = false;

        const formatInline = (text) => text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        lines.forEach(line => {
            const trimmedLine = line.trim();

            // Handle lists
            if (trimmedLine.startsWith('- ')) {
                if (!inList) {
                    html += '<ul>';
                    inList = true;
                }
                html += `<li>${formatInline(trimmedLine.substring(2))}</li>`;
            } else {
                // If a non-list line is encountered, close the list
                if (inList) {
                    html += '</ul>';
                    inList = false;
                }

                // Handle other block elements
                if (trimmedLine.startsWith('# ')) {
                    html += `<h1>${formatInline(trimmedLine.substring(2))}</h1>`;
                } else if (trimmedLine.startsWith('## ')) {
                    html += `<h2>${formatInline(trimmedLine.substring(3))}</h2>`;
                } else if (trimmedLine.startsWith('### ')) {
                    html += `<h3>${formatInline(trimmedLine.substring(4))}</h3>`;
                } else if (trimmedLine.match(/^---\s*$/)) {
                    html += '<hr>';
                } else if (trimmedLine.length > 0) {
                    // This is a paragraph
                    html += `<p>${formatInline(trimmedLine.replace(/  $/, '<br>'))}</p>`;
                }
            }
        });

        // Close any list that might be open at the end of the file
        if (inList) {
            html += '</ul>';
        }

        return html;
    };


    // --- Main initialization function ---
    const initializeApp = async () => {
        try {
            const response = await fetch('./tif_score.csv');
            if (!response.ok) {
                throw new Error(`CSV„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${response.statusText}`);
            }
            const csvText = await response.text();
            const allData = parseCSV(csvText);
            
            surveyData = allData.filter(item => item['ÂÖ®ÂõûÁ≠îÊï∞'] >= 30);

            if (surveyData.length === 0) {
                 throw new Error('Ë°®Á§∫ÂØæË±°„Å®„Å™„Çã„Éá„Éº„ÇøÔºàÂõûÁ≠îÊï∞30‰ª∂‰ª•‰∏äÔºâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
            }
            
            loadingIndicator.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            appContainer.classList.remove('hidden');
            setupEventListeners();
        } catch (error) {
            loadingIndicator.innerHTML = `<p class="text-red-500 font-bold">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ</p><p class="text-sm mt-2">${error.message}</p>`;
            console.error(error);
        }
    };
    
    // --- Function to set up event listeners ---
    const setupEventListeners = () => {
        const analysisBtn = document.getElementById('analysis-btn');
        const analysisResults = document.getElementById('analysis-results');
        const introSection = document.getElementById('intro-section');
        const npsTab = document.getElementById('nps-tab');
        const satisfactionTab = document.getElementById('satisfaction-tab');
        const categoryFilter = document.getElementById('category-filter');
        const detailFilter = document.getElementById('detail-filter');
        const aboutButton = document.getElementById('about-button');
        const aboutModal = document.getElementById('about-modal');
        const closeAboutModalButton = document.getElementById('close-about-modal-button');
        const insightsBtn = document.getElementById('insights-btn');
        const insightsModal = document.getElementById('insights-modal');
        const closeInsightsModalButton = document.getElementById('close-insights-modal-button');
        let currentTab = 'nps';

        analysisBtn.addEventListener('click', () => {
            analysisResults.classList.toggle('hidden');
            if (analysisResults.classList.contains('hidden')) {
                introSection.classList.remove('mb-8');
                 appContainer.style.justifyContent = 'center';
            } else {
                introSection.classList.add('mb-8');
                 appContainer.style.justifyContent = 'flex-start';
                renderSimpleRanking(currentTab);
            }
        });

        npsTab.addEventListener('click', () => {
            if (currentTab !== 'nps') {
                currentTab = 'nps';
                npsTab.classList.add('active');
                satisfactionTab.classList.remove('active');
                renderSimpleRanking('nps');
            }
        });

        satisfactionTab.addEventListener('click', () => {
            if (currentTab !== 'satisfaction') {
                currentTab = 'satisfaction';
                satisfactionTab.classList.add('active');
                npsTab.classList.remove('active');
                renderSimpleRanking('satisfaction');
            }
        });
        
        categoryFilter.addEventListener('change', () => {
            const selectedCategory = categoryFilter.value;
            detailFilter.innerHTML = '<option selected value="">Ë©≥Á¥∞„ÇíÈÅ∏Êäû...</option>';
            document.getElementById('segment-ranking-container').innerHTML = '<p class="text-gray-500 text-center pt-10">Ë©≥Á¥∞„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';

            if (selectedCategory) {
                filterOptions[selectedCategory].forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    detailFilter.appendChild(optionElement);
                });
                detailFilter.disabled = false;
            } else {
                detailFilter.disabled = true;
                 document.getElementById('segment-ranking-container').innerHTML = '<p class="text-gray-500 text-center pt-10">„ÅØ„Åò„ÇÅ„Å´ÂàÜÊûêËª∏„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
            }
        });
        
        detailFilter.addEventListener('change', renderSegmentRanking);
        
        // --- Modal Listeners ---
        aboutButton.addEventListener('click', async () => {
            try {
                const response = await fetch('./aboutus.txt');
                if (!response.ok) throw new Error('File not found');
                const text = await response.text();
                document.getElementById('about-text').innerHTML = text.replace(/\n/g, '<br>');
                aboutModal.classList.remove('hidden');
            } catch(e) {
                document.getElementById('about-text').textContent = '„Éï„Ç°„Ç§„É´„ÅåË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ';
                aboutModal.classList.remove('hidden');
            }
        });
        closeAboutModalButton.addEventListener('click', () => aboutModal.classList.add('hidden'));
        aboutModal.addEventListener('click', (e) => { if(e.target === aboutModal) aboutModal.classList.add('hidden'); });

        insightsBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('./tifo_insights.md');
                if (!response.ok) throw new Error('File not found');
                const mdText = await response.text();
                document.getElementById('insights-text').innerHTML = parseMarkdown(mdText);
                insightsModal.classList.remove('hidden');
            } catch(e) {
                document.getElementById('insights-text').textContent = '„Éï„Ç°„Ç§„É´„ÅåË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ';
                insightsModal.classList.remove('hidden');
            }
        });
        closeInsightsModalButton.addEventListener('click', () => insightsModal.classList.add('hidden'));
        insightsModal.addEventListener('click', (e) => { if(e.target === insightsModal) insightsModal.classList.add('hidden'); });
    };

    // --- Ranking Card Drawing Function ---
    const createRankingCard = (rank, name, score, prefecture, unit = '') => {
        let rankClass = 'rank-default';
        if (rank === 1) rankClass = 'rank-1';
        if (rank === 2) rankClass = 'rank-2';
        if (rank === 3) rankClass = 'rank-3';

        const prefectureClasses = {
            "ÂØåÂ±±": "pref-toyama",
            "Áü≥Â∑ù": "pref-ishikawa",
            "Á¶è‰∫ï": "pref-fukui",
        };
        const prefClass = prefectureClasses[prefecture] || 'bg-gray-200 text-gray-800';
        const prefBadge = `<span class="pref-badge ${prefClass}">${prefecture}</span>`;
        
        const scoreDisplay = (typeof score === 'number')
            ? (unit === 'ÁÇπ' ? score.toFixed(2) : score.toFixed(1))
            : 'N/A';

        return `
            <div class="flex items-center bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
                <div class="rank-badge ${rankClass}">${rank}</div>
                <div class="flex-grow ml-4">
                    <p class="font-semibold text-gray-700">${name}</p>
                    <div class="mt-1">${prefBadge}</div>
                </div>
                <div class="text-right">
                    <p class="text-2xl font-bold" style="color: var(--tifo-primary-dark);">${scoreDisplay}<span class="text-sm text-gray-500 ml-1">${unit}</span></p>
                </div>
            </div>
        `;
    };
    
    // --- Data processing and rendering functions ---
    const getSortableNPS = (value) => {
        if (typeof value !== 'number') return -Infinity;
        return Math.abs(value) <= 1 ? value * 100 : value;
    };

    const renderSimpleRanking = (type) => {
        const rankingContainer = document.getElementById('ranking-container');
        const sortKey = type === 'nps' ? 'NPS' : 'ÊñΩË®≠ÂÖ®‰ΩìÊ∫ÄË∂≥Â∫¶';

        const sortedData = [...surveyData].sort((a, b) => {
            const valA = type === 'nps' ? getSortableNPS(a[sortKey]) : (a[sortKey] || -Infinity);
            const valB = type === 'nps' ? getSortableNPS(b[sortKey]) : (b[sortKey] || -Infinity);
            return valB - valA;
        });
        
        rankingContainer.innerHTML = sortedData
            .map((item, index) => {
                const scoreValue = item[sortKey];
                const score = type === 'nps' ? getSortableNPS(scoreValue) : scoreValue;
                return createRankingCard(index + 1, item['ÊñΩË®≠'], score, item['Áúå'], type === 'satisfaction' ? 'ÁÇπ' : '');
            })
            .join('');
    };

    const renderSegmentRanking = () => {
        const segmentRankingContainer = document.getElementById('segment-ranking-container');
        const filterValue = document.getElementById('detail-filter').value;

        if (!filterValue) {
            segmentRankingContainer.innerHTML = '<p class="text-gray-500 text-center pt-10">Ë©≥Á¥∞„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
            return;
        }

        const calculatedData = surveyData.map(item => {
            const segmentValue = item[filterValue];
            const percentage = (typeof segmentValue === 'number') ? segmentValue * 100 : -1;
            return { ...item, percentage: percentage };
        }).sort((a, b) => b.percentage - a.percentage);

        segmentRankingContainer.innerHTML = calculatedData
            .map((item, index) => {
                const score = item.percentage < 0 ? 'N/A' : item.percentage;
                return createRankingCard(index + 1, item['ÊñΩË®≠'], score, item['Áúå'], '%');
            })
            .join('');
    };

    // --- Start the application ---
    initializeApp();
});
</script>

</body>
</html>
