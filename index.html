<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIFO - 北陸３県観光データ猫型アドバイザリー</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="defalt">
    <link rel="icon" href="./favicon.ico">
    <link rel="apple-touch-icon" href="./tifo.png">
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tifo-bg: #F7FAFC;
            --tifo-text: #2D3748;
            --tifo-primary: #4FD1C5;
            --tifo-primary-dark: #38B2AC;
            --tifo-card-border: #E2E8F0;
            --tifo-card-bg: #FFFFFF;
            /* 県のカラーコード */
            --color-toyama-bg: #4db56a;
            --color-ishikawa-bg: #008cbe;
            --color-fukui-bg: #00006b;
            --color-pref-text: #ffffff;
        }
        body { font-family: 'Noto Sans JP', sans-serif; background-color: var(--tifo-bg); color: var(--tifo-text); display: flex; flex-direction: column; min-height: 100vh; }
        main#app-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .tifo-card { background-color: var(--tifo-card-bg); border-radius: 1.5rem; padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05); border: 1px solid var(--tifo-card-border); }
        .tifo-button { background-color: var(--tifo-primary); color: white; font-weight: bold; padding: 0.75rem 1.5rem; border-radius: 9999px; border-bottom: 4px solid var(--tifo-primary-dark); transition: all 0.2s ease; }
        .tifo-button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px -3px rgba(79, 209, 197, 0.4); }
        .tifo-button:active { transform: translateY(2px); border-bottom-width: 2px; }
        .main-tab-button { padding: 0.75rem 1.25rem; font-weight: 600; color: #A0AEC0; transition: all 0.2s ease; border-bottom: 4px solid transparent; font-size: 0.95rem; }
        .main-tab-button:hover { background-color: #F7FAFC; color: #4A5568; }
        .main-tab-button.active { color: var(--tifo-primary); border-bottom-color: var(--tifo-primary); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .sub-tab-button { padding: 0.75rem 1rem; border-bottom: 3px solid transparent; font-weight: 600; color: #A0AEC0; transition: all 0.2s ease; }
        .sub-tab-button:hover { background-color: #F7FAFC; color: #4A5568; }
        .sub-tab-button.active { color: var(--tifo-primary); border-bottom-color: var(--tifo-primary); }
        .period-button-group { display: inline-flex; border-radius: 0.75rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); border: 1px solid var(--tifo-card-border); overflow: hidden; background-color: #FFFFFF; }
        .period-button { padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 600; background-color: #FFFFFF; color: #6B7280; border-right: 1px solid var(--tifo-card-border); transition: all 0.2s ease; cursor: pointer; }
        .period-button:last-child { border-right: none; }
        .period-button:hover { background-color: #F9FAFB; }
        .period-button.active { background-color: var(--tifo-primary); color: white; box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); }
        .rank-badge { width: 2.25rem; height: 2.25rem; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; color: white; flex-shrink: 0; font-size: 1rem; }
        .rank-1 { background-color: #FFD700; } .rank-2 { background-color: #C0C0C0; } .rank-3 { background-color: #CD7F32; } .rank-4, .rank-5, .rank-default { background-color: #A9A9A9; }
        .pref-badge { font-size: 0.75rem; font-weight: 600; padding: 2px 8px; border-radius: 9999px; }
        .pref-toyama { background-color: var(--color-toyama-bg); color: var(--color-pref-text); } .pref-ishikawa { background-color: var(--color-ishikawa-bg); color: var(--color-pref-text); } .pref-fukui { background-color: var(--color-fukui-bg); color: var(--color-pref-text); }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; } .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; } .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; } .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 1rem; max-width: 90%; width: 700px; max-height: 80vh; overflow-y: auto; }
        .progress-bar-bg { background-color: #EDF2F7; border-radius: 9999px; overflow: hidden; height: 1.25rem; }
        .progress-bar { background-color: var(--tifo-primary); height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: bold; }
        .nps-bar-container { position: relative; background: linear-gradient(to right, #FEB2B2, #EDF2F7, #9AE6B4); height: 0.75rem; border-radius: 9999px; }
        .nps-bar-marker { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 2px; height: 1.25rem; background-color: rgba(113, 128, 150, 0.5); border-radius: 1px; }
        .nps-bar-value { position: absolute; top: 50%; transform: translateY(-50%); width: 0.75rem; height: 0.75rem; background-color: var(--tifo-text); border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3); transition: left 0.5s ease-in-out; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-indicator" class="min-h-screen flex flex-col items-center justify-center p-4 text-center"> <p class="text-gray-600">データを読み込んでいます...</p> </div>

    <main id="app-container" class="container mx-auto p-4 md:p-8 max-w-4xl hidden">
        <div id="intro-section">
             <header class="flex items-center justify-center gap-4 mb-4 text-center"> <a href="https://codefornoto.github.io/TIFO/" target="_blank" rel="noopener noreferrer"> <div class="w-24 h-24"> <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"> <path fill="var(--tifo-primary)" d="M47.9,-51.9C62.4,-41.2,74.7,-25.9,78.2,-8.1C81.7,9.7,76.4,30.1,64.8,44.2C53.2,58.3,35.3,66.1,17.7,70.8C0.1,75.5,-17.2,77.1,-33.1,70.2C-49,63.3,-63.5,47.9,-71.4,30.1C-79.3,12.3,-80.6,-7.8,-74.3,-24.1C-68,-40.4,-54.1,-52.9,-38.8,-60.1C-23.5,-67.3,-6.8,-69.2,8.9,-66.1C24.6,-63,47.9,-51.9,47.9,-51.9Z" transform="translate(100 100)"></path> <text x="50%" y="55%" text-anchor="middle" dominant-baseline="middle" font-size="50" font-weight="bold" fill="white" letter-spacing="2">TIFO</text> </svg> </div> </a> <img src="./tifo.png" alt="TIFOちゃん" class="h-20 w-20 object-contain"> </header> <p class="text-lg text-gray-600 mb-8 text-center">北陸３県観光データ猫型アドバイザリー</p>
            <section class="text-center mb-8 space-y-4"> <button id="analysis-btn" class="tifo-button text-lg px-8">北陸３県連携データ分析</button> </section>
        </div>

        <div id="analysis-results" class="hidden space-y-6">
            <div class="flex border-b border-gray-200 bg-white rounded-t-2xl px-2 pt-2" style="box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03);">
                <button id="main-tab-overall" class="main-tab-button active">全体ランキング</button>
                <button id="main-tab-segment" class="main-tab-button">属性別ランキング</button>
                <button id="main-tab-facility" class="main-tab-button">施設・エリア別データ</button>
            </div>
            <div class="tifo-card -mt-8 pt-8">
                <div id="panel-overall" class="tab-content active space-y-6">
                     <div class="flex justify-between items-center">
                         <h2 class="text-xl font-bold" style="color: var(--tifo-primary-dark);">全体ランキング</h2> <div class="period-button-group" id="period-selector-overall"> <button class="period-button active" data-period="all" data-target="overall">全期間</button> <button class="period-button" data-period="1y" data-target="overall">1年</button> <button class="period-button" data-period="3m" data-target="overall">3か月</button> </div>
                     </div>
                     <div class="flex border-b border-gray-200 -mt-2"> <button id="nps-tab" class="sub-tab-button active">NPS</button> <button id="satisfaction-tab" class="sub-tab-button">満足度(旅行全体)</button> </div>
                     <div id="ranking-container" class="custom-scrollbar h-96 overflow-y-auto pr-2 space-y-3"></div>
                </div>
                <div id="panel-segment" class="tab-content space-y-6">
                     <div class="flex justify-between items-center">
                          <h2 class="text-xl font-bold" style="color: var(--tifo-primary-dark);">セグメント別ランキング</h2> <div class="period-button-group" id="period-selector-segment"> <button class="period-button active" data-period="all" data-target="segment">全期間</button> <button class="period-button" data-period="1y" data-target="segment">1年</button> <button class="period-button" data-period="3m" data-target="segment">3か月</button> </div>
                     </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <select id="category-filter" class="w-full p-2.5 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-teal-400 focus:border-teal-400"> <option selected value="">分析軸を選択...</option> <option value="age">年代</option><option value="gender">性別</option><option value="stay">宿泊数</option><option value="companion">同伴者</option><option value="purpose">旅の目的</option><option value="prefecture">都道府県</option><option value="source">情報源</option><option value="income">世帯年収</option> </select> <select id="detail-filter" class="w-full p-2.5 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-teal-400 focus:border-teal-400" disabled> <option selected value="">詳細を選択...</option> </select> </div>
                     <div id="segment-ranking-container" class="custom-scrollbar h-96 overflow-y-auto pr-2 space-y-3 pt-4 border-t border-gray-200"><p class="text-gray-500 text-center pt-10">はじめに分析軸を選択してください。</p></div>
                </div>
                <div id="panel-facility" class="tab-content space-y-6">
                    <div class="flex flex-wrap justify-between items-center gap-4"> <h2 class="text-xl font-bold" style="color: var(--tifo-primary-dark);">訪問者データ</h2> <div class="period-button-group" id="pref-selector"> <button class="period-button active" data-pref="富山">富山</button> <button class="period-button" data-pref="石川">石川</button> <button class="period-button" data-pref="福井">福井</button> </div> <div class="period-button-group" id="period-selector-facility"> <button class="period-button active" data-period="all" data-target="facility">全期間</button> <button class="period-button" data-period="1y" data-target="facility">1年</button> <button class="period-button" data-period="3m" data-target="facility">3か月</button> </div> </div>
                    <div class="w-full"> <select id="facility-filter" class="w-full p-2.5 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-teal-400 focus:border-teal-400"> <option selected value="">施設・エリアを選択してください...</option> </select> </div>
                    <div id="facility-scores" class="hidden space-y-4 pt-4 border-t border-gray-200"> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <div class="tifo-card !shadow-none border text-center p-4"> <h3 class="text-lg font-bold mb-2">❤️ NPS (顧客推奨度)</h3> <p id="facility-nps-score" class="text-5xl font-bold" style="color: var(--tifo-primary);"></p> <p class="text-xs text-gray-500">(-100 ~ 100の範囲)</p> <div class="w-full mt-3 relative"><div class="nps-bar-container"><div class="nps-bar-marker"></div><div id="facility-nps-bar" class="nps-bar-value" style="left: 50%;"></div></div></div> </div> <div class="tifo-card !shadow-none border text-center p-4"> <h3 class="text-lg font-bold mb-2">🚗 満足度 (旅行全体)</h3> <div class="flex items-baseline justify-center"><p id="facility-satisfaction-score" class="text-5xl font-bold" style="color: var(--tifo-primary);"></p><span class="text-2xl font-bold text-gray-500">/ 5.0</span></div> <div class="w-full progress-bar-bg mt-3"><div id="facility-satisfaction-bar" class="progress-bar" style="height: 1.25rem;"></div></div> </div> </div> </div>
                    <div id="facility-detail-wrapper" class="hidden space-y-6 pt-4 border-t border-gray-200">
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-gray-700">属性別 来訪者割合 TOP 5</h3>
                            <div id="facility-attributes-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 gap-6">
                                <div class="tifo-card !shadow-none border p-4"><h4 class="text-md font-bold mb-3">年代</h4><ul id="attr-age" class="space-y-2"></ul></div>
                                <div class="tifo-card !shadow-none border p-4"><h4 class="text-md font-bold mb-3">性別</h4><ul id="attr-gender" class="space-y-2"></ul></div>
                                <div class="tifo-card !shadow-none border p-4"><h4 class="text-md font-bold mb-3">都道府県</h4><ul id="attr-prefecture" class="space-y-2"></ul></div>
                                <div class="tifo-card !shadow-none border p-4"><h4 class="text-md font-bold mb-3">旅の目的</h4><ul id="attr-purpose" class="space-y-2"></ul></div>
                                <div class="tifo-card !shadow-none border p-4"><h4 class="text-md font-bold mb-3">情報源</h4><ul id="attr-source" class="space-y-2"></ul></div>
                                <div class="tifo-card !shadow-none border p-4"><h4 class="text-md font-bold mb-3">世帯年収</h4><ul id="attr-income" class="space-y-2"></ul></div>
                                <div class="tifo-card !shadow-none border p-4"><h4 class="text-md font-bold mb-3">同伴者</h4><ul id="attr-companion" class="space-y-2"></ul></div>
                                <div class="tifo-card !shadow-none border p-4"><h4 class="text-md font-bold mb-3">宿泊数</h4><ul id="attr-stay" class="space-y-2"></ul></div>
                            </div>
                        </div>
                        <div id="ishikawa-detail-link-container" class="text-center mt-6 hidden"> <a href="https://codefornoto.github.io/TIFO/ishikawa/" target="_blank" rel="noopener noreferrer" class="tifo-button inline-block">詳細な分析はこちら</a> </div>
                    </div>
                    <div id="facility-prompt" class="pt-10"><p class="text-gray-500 text-center">施設・エリアを選択してください。</p></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="w-full p-4"> <div class="text-center"> <button id="about-button" class="text-sm text-gray-500 hover:underline">TIFOとは</button> </div> </footer>
    <div id="about-modal" class="modal-overlay hidden"> <div class="modal-content"> <h2 class="text-2xl font-bold mb-4">TIFOとは</h2> <div id="about-text" class="text-sm text-gray-600 leading-relaxed space-y-2"></div> <button id="close-about-modal-button" class="tifo-button mt-6 w-full">閉じる</button> </div> </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    let allSurveyData = { '3m': [], '1y': [], 'all': [] };
    // let allCommentData = []; // Removed
    let allFacilityLists = { '3m': {}, '1y': {}, 'all': {} };
    let currentPeriod = 'all';
    let currentPref = '富山'; // Facility tab specific state
    let currentSurveyDataForRankings = []; // For ranking tabs (all prefectures)
    let currentFacilityList = []; // For facility tab (filtered by currentPref)
    let currentOverallTab = 'nps';

    const loadingIndicator = document.getElementById('loading-indicator');
    const appContainer = document.getElementById('app-container');

    const filterOptions = { /* 省略 */
        age: ['10代','20代','30代','40代','50代','60代','70代','80代','90代','100代'], gender: ['男', '女'], stay: ['日帰り', '1泊', '2泊', '3泊', '4泊以上'], companion: ['自分ひとり','恋人','友人','夫婦2人','団体旅行','親戚','親','職場の同僚','小学生以下連れの家族','中学生以下連れの家族','高校生連れの家族','災害支援'], purpose: ['宿でのんびり過ごす','温泉や露天風呂','地元の美味しいものを食べる','花見や紅葉などの自然鑑賞','名所、旧跡の観光','テーマパーク（遊園地、動物園、博物館など）','買い物、アウトレット','お祭りやイベントへの参加・見物','スポーツ観戦や芸能鑑賞（コンサート等）','アウトドア（海水浴、釣り、登山など）','まちあるき、都市散策','各種体験（手作り、果物狩りなど）','スキー・スノボ、マリンスポーツ','その他スポーツ（ゴルフ、テニスなど）','ドライブ・ツーリング','友人・親戚を尋ねる','出張など仕事関係'], prefecture: ['北海道','青森県','岩手県','宮城県','秋田県','山形県','福島県','茨城県','栃木県','群馬県','埼玉県','千葉県','東京都','神奈川県','新潟県','富山県','石川県','福井県','山梨県','長野県','岐阜県','静岡県','愛知県','三重県','滋賀県','京都府','大阪府','兵庫県','奈良県','和歌山県','鳥取県','島根県','岡山県','広島県','山口県','徳島県','香川県','愛媛県','高知県','福岡県','佐賀県','長崎県','熊本県','大分県','宮崎県','鹿児島県','沖縄県'], source: ['Facebook','Google','Googleマップ','Instagram','TikTok','X（旧Twitter）','YouTube','SNS広告','ブログ','まとめサイト','インターネット・アプリ','デジタルニュース','宿泊予約Webサイト','宿泊施設','TV・ラジオ番組やCM','ラブライブのスタンプラリー','新聞・雑誌・ガイドブック','旅行会社','友人・知人','地元の人','観光パンフレット・ポスター','観光案内所','観光展・物産展','観光連盟やDMOのHP','その他'],
        // (MODIFIED) Income options based on prefecture
        income_default: ['100万円未満', '100万円以上 200万円未満', '200万円以上 300万円未満', '300万円以上 400万円未満', '400万円以上 500万円未満', '500万円以上 600万円未満', '600万円以上 700万円未満', '700万円以上 800万円未満', '800万円以上 900万円未満', '900万円以上 1,000万円未満', '1,000万円以上 1,200万円未満', '1,200万円以上 1,500万円未満', '1,500万円以上', '分からない/無回答'],
        income_toyama: ['1: 300万円未満', '2: 300〜599万円', '3: 600〜1000万円', '4: 1000〜2000万円', '5: 2000万円以上', '6: 無回答']
    };
    // Add 'income' alias for default for easier access in segment ranking dropdown
    filterOptions['income'] = filterOptions['income_default'];

    const facilityAttributeCategories = { /* 省略 */
        'age': { title: '年代', columns: filterOptions.age, container: document.getElementById('attr-age') }, 'gender': { title: '性別', columns: filterOptions.gender, container: document.getElementById('attr-gender') }, 'prefecture': { title: '都道府県', columns: filterOptions.prefecture, container: document.getElementById('attr-prefecture') }, 'purpose': { title: '旅の目的', columns: filterOptions.purpose, container: document.getElementById('attr-purpose') }, 'source': { title: '情報源', columns: filterOptions.source, container: document.getElementById('attr-source') }, 'income': { title: '世帯年収', columns: [], container: document.getElementById('attr-income') }, // Columns set dynamically
         'companion': { title: '同伴者', columns: filterOptions.companion, container: document.getElementById('attr-companion') }, 'stay': { title: '宿泊数', columns: filterOptions.stay, container: document.getElementById('attr-stay') }
    };

    const parseCSV = (csvText) => { /* 省略 */
        if (csvText.charCodeAt(0) === 0xFEFF) csvText = csvText.slice(1); const lines = csvText.trim().replace(/\r/g, '').split('\n'); if (lines.length < 2) return []; const csvRegex = /(?:^|,)(?:"([^"]*(?:""[^"]*)*)"|([^,]*))/g; const parseLine = (line) => { const values = []; let match; csvRegex.lastIndex = 0; while (match = csvRegex.exec(line)) values.push(match[1] ? match[1].replace(/""/g, '"') : match[2]); return values; }; const headers = parseLine(lines[0]).map(h => h.trim() === '回答場所' ? '施設' : h.trim()); return lines.slice(1).map(line => { if (!line.trim()) return null; const values = parseLine(line); const entry = {}; headers.forEach((header, index) => { const key = header; const rawValue = (values[index] || '').trim(); if (rawValue === '') entry[key] = null; else { const numValue = parseFloat(rawValue); entry[key] = !isNaN(numValue) ? numValue : rawValue; } }); entry['県'] = entry['TIF'] || null; return entry; }).filter(Boolean);
    };

    // (DELETED) parseTSV removed

    // (MODIFIED) initializeApp - remove TSV loading logic
    const initializeApp = async () => {
        try {
            // TSV loading removed
            const [csvAll, csv1y, csv3m] = await Promise.all([ fetch('./tifo_score_all.csv').then(res => res.text()), fetch('./tifo_score_1y.csv').then(res => res.text()), fetch('./tifo_score_3m.csv').then(res => res.text()) ]);
            allSurveyData['all'] = parseCSV(csvAll); allSurveyData['1y'] = parseCSV(csv1y); allSurveyData['3m'] = parseCSV(csv3m);
            if (allSurveyData['all'].length === 0) throw new Error('表示対象となるデータ（全期間）がありません。');
            ['all', '1y', '3m'].forEach(period => {
                const list = { "富山": [], "石川": [], "福井": [] }; const filteredData = allSurveyData[period].filter(item => item['回答数'] >= 30 && item['県']);
                filteredData.forEach(item => { if (list[item['県']] && item['施設']) list[item['県']].push(item['施設']); });
                list["富山"].sort(); list["石川"].sort(); list["福井"].sort(); allFacilityLists[period] = list;
            });
            updateCurrentData();
            loadingIndicator.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); appContainer.classList.remove('hidden');
            setupEventListeners();
            updateFacilityFilter(); // Initial draw for default selection (Toyama, All)
            handleDataFilterChange(); // Render initial tab content (Overall Ranking)

        } catch (error) { loadingIndicator.innerHTML = `<p class="text-red-500 font-bold">エラーが発生しました。</p><p class="text-sm mt-2">${error.message}</p>`; console.error(error); }
    };

    const updateCurrentData = () => { /* 省略 */
        currentSurveyDataForRankings = allSurveyData[currentPeriod].filter(d => d['回答数'] >= 30); currentFacilityList = allFacilityLists[currentPeriod][currentPref] || [];
    };
    const updateFacilityFilter = () => { /* 省略 */
        const facilityFilter = document.getElementById('facility-filter'); facilityFilter.innerHTML = '<option selected value="">施設・エリアを選択してください...</option>'; currentFacilityList.forEach(facilityName => { const opt = document.createElement('option'); opt.value = facilityName; opt.textContent = facilityName; facilityFilter.appendChild(opt); }); resetFacilityDetailView();
    };
    const resetFacilityDetailView = () => { /* 省略 */
        document.getElementById('facility-scores').classList.add('hidden'); document.getElementById('facility-detail-wrapper').classList.add('hidden'); document.getElementById('facility-prompt').classList.remove('hidden'); const promptEl = document.getElementById('facility-prompt'); if (currentFacilityList.length === 0) promptEl.innerHTML = `<p class="text-gray-500 text-center pt-10">${currentPref}にはこの期間のデータがありません。</p>`; else promptEl.innerHTML = '<p class="text-gray-500 text-center pt-10">施設・エリアを選択してください。</p>'; document.getElementById('ishikawa-detail-link-container').classList.add('hidden'); // Hide Ishikawa button on reset
    };
    const setupEventListeners = () => { /* 省略 */
        const analysisBtn = document.getElementById('analysis-btn'); const analysisResults = document.getElementById('analysis-results'); const introSection = document.getElementById('intro-section'); const mainTabs = [{ btn: document.getElementById('main-tab-overall'), panel: document.getElementById('panel-overall') }, { btn: document.getElementById('main-tab-segment'), panel: document.getElementById('panel-segment') }, { btn: document.getElementById('main-tab-facility'), panel: document.getElementById('panel-facility') }]; const npsTab = document.getElementById('nps-tab'); const satisfactionTab = document.getElementById('satisfaction-tab'); const categoryFilter = document.getElementById('category-filter'); const detailFilter = document.getElementById('detail-filter'); const facilityFilter = document.getElementById('facility-filter'); const aboutButton = document.getElementById('about-button'); const aboutModal = document.getElementById('about-modal'); const closeAboutModalButton = document.getElementById('close-about-modal-button');
        analysisBtn.addEventListener('click', () => { analysisResults.classList.toggle('hidden'); if (analysisResults.classList.contains('hidden')) { introSection.classList.remove('mb-8'); appContainer.style.justifyContent = 'center'; } else { introSection.classList.add('mb-8'); appContainer.style.justifyContent = 'flex-start'; handleDataFilterChange(); } });
        mainTabs.forEach(tab => { tab.btn.addEventListener('click', () => { mainTabs.forEach(t => { t.btn.classList.remove('active'); t.panel.classList.remove('active'); }); tab.btn.classList.add('active'); tab.panel.classList.add('active'); handleDataFilterChange(); }); });
        document.querySelectorAll('#pref-selector .period-button').forEach(button => { button.addEventListener('click', (e) => { if (e.target.classList.contains('active')) return; currentPref = e.target.dataset.pref; document.querySelectorAll('#pref-selector .period-button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); handleDataFilterChange(); }); });
        document.querySelectorAll('.period-button-group[id^="period-selector-"]').forEach(group => { group.querySelectorAll('.period-button').forEach(button => { button.addEventListener('click', (e) => { if (e.target.classList.contains('active')) return; currentPeriod = e.target.dataset.period; document.querySelectorAll(`.period-button[data-period]`).forEach(btn => btn.classList.remove('active')); document.querySelectorAll(`.period-button[data-period="${currentPeriod}"]`).forEach(btn => btn.classList.add('active')); handleDataFilterChange(); }); }); });
        const handleDataFilterChange = () => { updateCurrentData(); const activeTabId = document.querySelector('.main-tab-button.active').id; if (activeTabId === 'main-tab-facility') updateFacilityFilter(); else if (activeTabId === 'main-tab-segment') { renderSegmentRanking(); categoryFilter.value = ""; detailFilter.innerHTML = '<option selected value="">詳細...</option>'; detailFilter.disabled = true; } else if (activeTabId === 'main-tab-overall') renderSimpleRanking(currentOverallTab); };
        npsTab.addEventListener('click', () => { if (currentOverallTab !== 'nps') { currentOverallTab = 'nps'; npsTab.classList.add('active'); satisfactionTab.classList.remove('active'); renderSimpleRanking('nps'); } }); satisfactionTab.addEventListener('click', () => { if (currentOverallTab !== 'satisfaction') { currentOverallTab = 'satisfaction'; satisfactionTab.classList.add('active'); npsTab.classList.remove('active'); renderSimpleRanking('satisfaction'); } });
        categoryFilter.addEventListener('change', () => { const selectedCategory = categoryFilter.value; detailFilter.innerHTML = '<option selected value="">詳細を選択...</option>'; document.getElementById('segment-ranking-container').innerHTML = '<p class="text-gray-500 text-center pt-10">詳細...</p>'; if (selectedCategory) { filterOptions[selectedCategory].forEach(option => { const opt = document.createElement('option'); opt.value = option; opt.textContent = option; detailFilter.appendChild(opt); }); detailFilter.disabled = false; } else { detailFilter.disabled = true; document.getElementById('segment-ranking-container').innerHTML = '<p class="text-gray-500 text-center pt-10">分析軸...</p>'; } }); detailFilter.addEventListener('change', renderSegmentRanking); facilityFilter.addEventListener('change', () => renderFacilityDetail(facilityFilter.value));
        aboutButton.addEventListener('click', async () => { try { const res = await fetch('./aboutus.txt'); if (!res.ok) throw new Error(''); const txt = await res.text(); document.getElementById('about-text').innerHTML = txt.replace(/\n/g, '<br>'); aboutModal.classList.remove('hidden'); } catch (e) { document.getElementById('about-text').textContent = 'ファイル読込失敗'; aboutModal.classList.remove('hidden'); } }); closeAboutModalButton.addEventListener('click', () => aboutModal.classList.add('hidden')); aboutModal.addEventListener('click', (e) => { if (e.target === aboutModal) aboutModal.classList.add('hidden'); });
    };

    const createRankingCard = (rank, name, score, detailOrPref, unit = '') => { /* 省略 */
        let rC='rank-default';if(rank===1)rC='rank-1';if(rank===2)rC='rank-2';if(rank===3)rC='rank-3';if(rank===4)rC='rank-4';if(rank===5)rC='rank-5';const pC={"富山":"pref-toyama","石川":"pref-ishikawa","福井":"pref-fukui"};let bH='';if(pC[detailOrPref])bH=`<span class="pref-badge ${pC[detailOrPref]}">${detailOrPref}</span>`;else bH=`<span class="pref-badge bg-gray-200 text-gray-700">${detailOrPref}</span>`;const sD=(typeof score==='number')?(unit==='点'?score.toFixed(2):score.toFixed(1)):'N/A';return `<div class="flex items-center bg-white p-3 rounded-xl border border-gray-200 shadow-sm"><div class="rank-badge ${rC}">${rank}</div><div class="flex-grow ml-4 min-w-0"><p class="font-semibold text-gray-700 truncate" title="${name}">${name}</p><div class="mt-1">${bH}</div></div><div class="text-right flex-shrink-0 ml-2"><p class="text-2xl font-bold" style="color: var(--tifo-primary-dark);">${sD}<span class="text-sm text-gray-500 ml-1">${unit}</span></p></div></div>`;
    };
    const createAttributeRankingList = (topData) => { /* 省略 */
        if(topData.length===0)return '<li class="text-gray-500 text-sm">データなし</li>';return topData.map(([key,percentage],index)=>{const pD=percentage.toFixed(1);let rC='rank-default';if(index===0)rC='rank-1';if(index===1)rC='rank-2';if(index===2)rC='rank-3';if(index===3)rC='rank-4';if(index===4)rC='rank-5';return `<li class="flex items-center text-sm"><span class="rank-badge !w-6 !h-6 !text-xs ${rC}">${index+1}</span><span class="ml-2 flex-1 text-gray-700 truncate" title="${key}">${key}</span><span class="font-bold w-16 text-right" style="color: var(--tifo-primary-dark);">${pD}%</span></li>`;}).join('');
    };

    // (DELETED) createCommentCard function removed

    const getSortableNPS = (value) => { if (typeof value !== 'number') return -Infinity; return Math.abs(value) <= 1 ? value * 100 : value; };
    const renderSimpleRanking = (type) => { /* 省略 */
        const rC=document.getElementById('ranking-container');if(currentSurveyDataForRankings.length===0){rC.innerHTML=`<p class="text-gray-500 text-center pt-10">この条件のデータはありません。</p>`;return;}const sK=type==='nps'?'NPS':'満足度（旅行全体）';const sD=[...currentSurveyDataForRankings].sort((a,b)=>{const vA=type==='nps'?getSortableNPS(a[sK]):(a[sK]||-Infinity);const vB=type==='nps'?getSortableNPS(b[sK]):(b[sK]||-Infinity);return vB-vA;});rC.innerHTML=sD.map((item,index)=>{const sV=item[sK];const score=type==='nps'?getSortableNPS(sV):sV;return createRankingCard(index+1,item['施設'],score,item['県'],type==='satisfaction'?'点':'');}).join('');
    };
    const renderSegmentRanking = () => { /* 省略: Calculation correct now */
        const sRC=document.getElementById('segment-ranking-container');const fV=document.getElementById('detail-filter').value;if(currentSurveyDataForRankings.length===0){sRC.innerHTML=`<p class="text-gray-500 text-center pt-10">この条件のデータはありません。</p>`;return;}if(!fV){sRC.innerHTML='<p class="text-gray-500 text-center pt-10">詳細を選択してください。</p>';return;}const cD=currentSurveyDataForRankings.map(item=>{const count=item[fV];const total=item['回答数'];const percentage=(typeof count==='number'&&total>0)?(count/total)*100:-1;return{...item,percentage:percentage};}).sort((a,b)=>b.percentage-a.percentage);sRC.innerHTML=cD.map((item,index)=>{const score=item.percentage<0?'N/A':item.percentage;return createRankingCard(index+1,item['施設'],score,item['県'],'%');}).join('');
    };

    // (MODIFIED) Render Facility Detail Function
    const renderFacilityDetail = (facilityName) => {
        const scoresContainer = document.getElementById('facility-scores'); const detailWrapper = document.getElementById('facility-detail-wrapper'); const prompt = document.getElementById('facility-prompt'); const ishikawaLinkContainer = document.getElementById('ishikawa-detail-link-container'); // Get Ishikawa button container
        // (DELETED) commentsContainer removed
        if (!facilityName) { resetFacilityDetailView(); return; }
        const facilityData = allSurveyData[currentPeriod].find(item => item['施設'] === facilityName && item['県'] === currentPref);
        if (!facilityData || facilityData['回答数'] < 30) { resetFacilityDetailView(); prompt.innerHTML = '<p class="text-red-500 text-center pt-10">この施設のデータが見つからないか、回答数が30未満です。</p>'; return; }
        scoresContainer.classList.remove('hidden'); detailWrapper.classList.remove('hidden'); prompt.classList.add('hidden');

        // --- 1. NPSと満足度ゲージ ---
        const npsRaw = facilityData['NPS']; const npsScore = npsRaw !== null && npsRaw !== undefined ? getSortableNPS(npsRaw).toFixed(1) : 'N/A'; document.getElementById('facility-nps-score').textContent = npsScore; const normalizedNpsPercent = npsScore !== 'N/A' ? (Number(npsScore) + 100) / 2 : 50; document.getElementById('facility-nps-bar').style.left = `calc(${normalizedNpsPercent}% - 0.375rem)`;
        const satisfaction = facilityData['満足度（旅行全体）']; const satisfactionScore = (satisfaction && !isNaN(satisfaction)) ? Number(satisfaction) : 0; document.getElementById('facility-satisfaction-score').textContent = satisfactionScore.toFixed(1); document.getElementById('facility-satisfaction-bar').style.width = `${(satisfactionScore / 5) * 100}%`;

        // --- 2. 属性TOP5 ---
        const totalAnswers = facilityData['回答数'];
        for (const categoryKey in facilityAttributeCategories) {
            const category = facilityAttributeCategories[categoryKey]; let segments = [];
            // (MODIFIED) Dynamically set income columns based on prefecture
            let incomeColumns = (currentPref === '富山') ? filterOptions.income_toyama : filterOptions.income_default;
            let columnsToUse = (categoryKey === 'income') ? incomeColumns : category.columns;

            columnsToUse.forEach(colName => {
                if (facilityData.hasOwnProperty(colName)) {
                    const count = facilityData[colName]; // Assume count
                    if (typeof count === 'number' && count > 0 && totalAnswers > 0) {
                        const percentage = (count / totalAnswers) * 100; segments.push([colName, percentage]);
                    }
                }
            });
            segments.sort((a, b) => b[1] - a[1]); const top5Segments = segments.slice(0, 5);
            if (category.container) category.container.innerHTML = createAttributeRankingList(top5Segments);
            else console.error(`Container not found for category: ${categoryKey}`);
        }

        // --- 3. (DELETED) 自由記述コメントの描画ロジックを削除 ---

        // --- 4. 石川県詳細リンクの表示制御 ---
        if (currentPref === '石川') ishikawaLinkContainer.classList.remove('hidden');
        else ishikawaLinkContainer.classList.add('hidden');
    };

    initializeApp();
});
</script>

</body>
</html>
