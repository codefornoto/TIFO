<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIFO - åŒ—é™¸ï¼“çœŒè¦³å…‰ãƒ‡ãƒ¼ã‚¿çŒ«å‹ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªãƒ¼</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="defalt">
    <link rel="icon" href="./favicon.ico">
    <link rel="apple-touch-icon" href="./tifo.png">
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tifo-bg: #F7FAFC;
            --tifo-text: #2D3748;
            --tifo-primary: #4FD1C5;
            --tifo-primary-dark: #38B2AC;
            --tifo-card-border: #E2E8F0;
            --tifo-card-bg: #FFFFFF;
            /* çœŒã®ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ */
            --color-toyama-bg: #4db56a;
            --color-ishikawa-bg: #008cbe;
            --color-fukui-bg: #00006b;
            --color-pref-text: #ffffff;
        }
        body { font-family: 'Noto Sans JP', sans-serif; background-color: var(--tifo-bg); color: var(--tifo-text); display: flex; flex-direction: column; min-height: 100vh; }
        main#app-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .tifo-card { background-color: var(--tifo-card-bg); border-radius: 1.5rem; padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05); border: 1px solid var(--tifo-card-border); }
        .tifo-button { background-color: var(--tifo-primary); color: white; font-weight: bold; padding: 0.75rem 1.5rem; border-radius: 9999px; border-bottom: 4px solid var(--tifo-primary-dark); transition: all 0.2s ease; }
        .tifo-button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px -3px rgba(79, 209, 197, 0.4); }
        .tifo-button:active { transform: translateY(2px); border-bottom-width: 2px; }
        .main-tab-button { padding: 0.75rem 1.25rem; font-weight: 600; color: #A0AEC0; transition: all 0.2s ease; border-bottom: 4px solid transparent; font-size: 0.95rem; }
        .main-tab-button:hover { background-color: #F7FAFC; color: #4A5568; }
        .main-tab-button.active { color: var(--tifo-primary); border-bottom-color: var(--tifo-primary); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .sub-tab-button { padding: 0.75rem 1rem; border-bottom: 3px solid transparent; font-weight: 600; color: #A0AEC0; transition: all 0.2s ease; }
        .sub-tab-button:hover { background-color: #F7FAFC; color: #4A5568; }
        .sub-tab-button.active { color: var(--tifo-primary); border-bottom-color: var(--tifo-primary); }
        .period-button-group { display: inline-flex; border-radius: 0.75rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); border: 1px solid var(--tifo-card-border); overflow: hidden; background-color: #FFFFFF; }
        .period-button { padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 600; background-color: #FFFFFF; color: #6B7280; border-right: 1px solid var(--tifo-card-border); transition: all 0.2s ease; cursor: pointer; }
        .period-button:last-child { border-right: none; }
        .period-button:hover { background-color: #F9FAFB; }
        .period-button.active { background-color: var(--tifo-primary); color: white; box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); }
        .rank-badge { width: 2.25rem; height: 2.25rem; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; color: white; flex-shrink: 0; font-size: 1rem; }
        .rank-1 { background-color: #FFD700; } .rank-2 { background-color: #C0C0C0; } .rank-3 { background-color: #CD7F32; } .rank-4, .rank-5, .rank-default { background-color: #A9A9A9; }
        .pref-badge { font-size: 0.75rem; font-weight: 600; padding: 2px 8px; border-radius: 9999px; }
        .pref-toyama { background-color: var(--color-toyama-bg); color: var(--color-pref-text); } .pref-ishikawa { background-color: var(--color-ishikawa-bg); color: var(--color-pref-text); } .pref-fukui { background-color: var(--color-fukui-bg); color: var(--color-pref-text); }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; } .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; } .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; } .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 1rem; max-width: 90%; width: 700px; max-height: 80vh; overflow-y: auto; }
        .progress-bar-bg { background-color: #EDF2F7; border-radius: 9999px; overflow: hidden; height: 1.25rem; }
        .progress-bar { background-color: var(--tifo-primary); height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: bold; }
        .nps-bar-container { position: relative; background: linear-gradient(to right, #FEB2B2, #EDF2F7, #9AE6B4); height: 0.75rem; border-radius: 9999px; }
        .nps-bar-marker { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 2px; height: 1.25rem; background-color: rgba(113, 128, 150, 0.5); border-radius: 1px; }
        .nps-bar-value { position: absolute; top: 50%; transform: translateY(-50%); width: 0.75rem; height: 0.75rem; background-color: var(--tifo-text); border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3); transition: left 0.5s ease-in-out; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-indicator" class="min-h-screen flex flex-col items-center justify-center p-4 text-center"> <p class="text-gray-600">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p> </div>

    <main id="app-container" class="container mx-auto p-4 md:p-8 max-w-4xl hidden">
        <div id="intro-section">
             <header class="flex items-center justify-center gap-4 mb-4 text-center"> <a href="https://codefornoto.github.io/TIFO/" target="_blank" rel="noopener noreferrer"> <div class="w-24 h-24"> <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"> <path fill="var(--tifo-primary)" d="M47.9,-51.9C62.4,-41.2,74.7,-25.9,78.2,-8.1C81.7,9.7,76.4,30.1,64.8,44.2C53.2,58.3,35.3,66.1,17.7,70.8C0.1,75.5,-17.2,77.1,-33.1,70.2C-49,63.3,-63.5,47.9,-71.4,30.1C-79.3,12.3,-80.6,-7.8,-74.3,-24.1C-68,-40.4,-54.1,-52.9,-38.8,-60.1C-23.5,-67.3,-6.8,-69.2,8.9,-66.1C24.6,-63,47.9,-51.9,47.9,-51.9Z" transform="translate(100 100)"></path> <text x="50%" y="55%" text-anchor="middle" dominant-baseline="middle" font-size="50" font-weight="bold" fill="white" letter-spacing="2">TIFO</text> </svg> </div> </a> <img src="./tifo.png" alt="TIFOã¡ã‚ƒã‚“" class="h-20 w-20 object-contain"> </header> <p class="text-lg text-gray-600 mb-8 text-center">åŒ—é™¸ï¼“çœŒè¦³å…‰ãƒ‡ãƒ¼ã‚¿çŒ«å‹ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªãƒ¼</p>
            <section class="text-center mb-8 space-y-4"> <button id="analysis-btn" class="tifo-button text-lg px-8">åŒ—é™¸ï¼“çœŒé€£æºãƒ‡ãƒ¼ã‚¿åˆ†æ</button> </section>
        </div>

        <div id="analysis-results" class="hidden space-y-6">
            <div class="flex border-b border-gray-200 bg-white rounded-t-2xl px-2 pt-2" style="box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03);">
                <button id="main-tab-overall" class="main-tab-button active">å…¨ä½“ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
                <button id="main-tab-segment" class="main-tab-button">å±æ€§åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
                <button id="main-tab-facility" class="main-tab-button">æ–½è¨­ãƒ»ã‚¨ãƒªã‚¢åˆ¥ãƒ‡ãƒ¼ã‚¿</button>
            </div>
            <div class="tifo-card -mt-8 pt-8">
                <div id="panel-overall" class="tab-content active space-y-6">
                     <div class="flex justify-between items-center">
                         <h2 class="text-xl font-bold" style="color: var(--tifo-primary-dark);">å…¨ä½“ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2> <div class="period-button-group" id="period-selector-overall"> <button class="period-button active" data-period="all" data-target="overall">å…¨æœŸé–“</button> <button class="period-button" data-period="1y" data-target="overall">1å¹´</button> <button class="period-button" data-period="3m" data-target="overall">3ã‹æœˆ</button> </div>
                     </div>
                     <div class="flex border-b border-gray-200 -mt-2"> <button id="nps-tab" class="sub-tab-button active">NPS</button> <button id="satisfaction-tab" class="sub-tab-button">æº€è¶³åº¦(æ—…è¡Œå…¨ä½“)</button> </div>
                     <div id="ranking-container" class="custom-scrollbar h-96 overflow-y-auto pr-2 space-y-3"></div>
                </div>
                <div id="panel-segment" class="tab-content space-y-6">
                     <div class="flex justify-between items-center">
                          <h2 class="text-xl font-bold" style="color: var(--tifo-primary-dark);">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2> <div class="period-button-group" id="period-selector-segment"> <button class="period-button active" data-period="all" data-target="segment">å…¨æœŸé–“</button> <button class="period-button" data-period="1y" data-target="segment">1å¹´</button> <button class="period-button" data-period="3m" data-target="segment">3ã‹æœˆ</button> </div>
                     </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <select id="category-filter" class="w-full p-2.5 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-teal-400 focus:border-teal-400"> <option selected value="">åˆ†æè»¸ã‚’é¸æŠ...</option> <option value="age">å¹´ä»£</option><option value="gender">æ€§åˆ¥</option><option value="stay">å®¿æ³Šæ•°</option><option value="companion">åŒä¼´è€…</option><option value="purpose">æ—…ã®ç›®çš„</option><option value="prefecture">éƒ½é“åºœçœŒ</option><option value="source">æƒ…å ±æº</option><option value="income">ä¸–å¸¯å¹´å</option> </select> <select id="detail-filter" class="w-full p-2.5 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-teal-400 focus:border-teal-400" disabled> <option selected value="">è©³ç´°ã‚’é¸æŠ...</option> </select> </div>
                     <div id="segment-ranking-container" class="custom-scrollbar h-96 overflow-y-auto pr-2 space-y-3 pt-4 border-t border-gray-200"><p class="text-gray-500 text-center pt-10">ã¯ã˜ã‚ã«åˆ†æè»¸ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p></div>
                </div>
                <div id="panel-facility" class="tab-content space-y-6">
                    <div class="flex flex-wrap justify-between items-center gap-4"> <h2 class="text-xl font-bold" style="color: var(--tifo-primary-dark);">è¨ªå•è€…ãƒ‡ãƒ¼ã‚¿</h2> <div class="period-button-group" id="pref-selector"> <button class="period-button active" data-pref="å¯Œå±±">å¯Œå±±</button> <button class="period-button" data-pref="çŸ³å·">çŸ³å·</button> <button class="period-button" data-pref="ç¦äº•">ç¦äº•</button> </div> <div class="period-button-group" id="period-selector-facility"> <button class="period-button active" data-period="all" data-target="facility">å…¨æœŸé–“</button> <button class="period-button" data-period="1y" data-target="facility">1å¹´</button> <button class="period-button" data-period="3m" data-target="facility">3ã‹æœˆ</button> </div> </div>
                    <div class="w-full"> <select id="facility-filter" class="w-full p-2.5 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-teal-400 focus:border-teal-400"> <option selected value="">æ–½è¨­ãƒ»ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„...</option> </select> </div>
                    <div id="facility-scores" class="hidden space-y-4 pt-4 border-t border-gray-200"> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <div class="tifo-card !shadow-none border text-center p-4"> <h3 class="text-lg font-bold mb-2">â¤ï¸ NPS (é¡§å®¢æ¨å¥¨åº¦)</h3> <p id="facility-nps-score" class="text-5xl font-bold" style="color: var(--tifo-primary);"></p> <p class="text-xs text-gray-500">(-100 ~ 100ã®ç¯„å›²)</p> <div class="w-full mt-3 relative"><div class="nps-bar-container"><div class="nps-bar-marker"></div><div id="facility-nps-bar" class="nps-bar-value" style="left: 50%;"></div></div></div> </div> <div class="tifo-card !shadow-none border text-center p-4"> <h3 class="text-lg font-bold mb-2">ğŸš— æº€è¶³åº¦ (æ—…è¡Œå…¨ä½“)</h3> <div class="flex items-baseline justify-center"><p id="facility-satisfaction-score" class="text-5xl font-bold" style="color: var(--tifo-primary);"></p><span class="text-2xl font-bold text-gray-500">/ 5.0</span></div> <div class="w-full progress-bar-bg mt-3"><div id="facility-satisfaction-bar" class="progress-bar" style="height: 1.25rem;"></div></div> </div> </div> </div>
                    <div id="facility-detail-wrapper" class="hidden space-y-6 pt-4 border-t border-gray-200">
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-gray-700">å±æ€§åˆ¥ æ¥è¨ªè€…å‰²åˆ TOP 5</h3>
                            <div id="facility-attributes-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 gap-6">
                                <div class="tifo-card !shadow-none border p-4"><h4 class="text-md font-bold mb-3">å¹´ä»£</h4><ul id="attr-age" class="space-y-2"></ul></div>
                                <div class="tifo-card !shadow-none border p-4"><h4 class="text-md font-bold mb-3">æ€§åˆ¥</h4><ul id="attr-gender" class="space-y-2"></ul></div>
                                <div class="tifo-card !shadow-none border p-4"><h4 class="text-md font-bold mb-3">éƒ½é“åºœçœŒ</h4><ul id="attr-prefecture" class="space-y-2"></ul></div>
                                <div class="tifo-card !shadow-none border p-4"><h4 class="text-md font-bold mb-3">æ—…ã®ç›®çš„</h4><ul id="attr-purpose" class="space-y-2"></ul></div>
                                <div class="tifo-card !shadow-none border p-4"><h4 class="text-md font-bold mb-3">æƒ…å ±æº</h4><ul id="attr-source" class="space-y-2"></ul></div>
                                <div class="tifo-card !shadow-none border p-4"><h4 class="text-md font-bold mb-3">ä¸–å¸¯å¹´å</h4><ul id="attr-income" class="space-y-2"></ul></div>
                                <div class="tifo-card !shadow-none border p-4"><h4 class="text-md font-bold mb-3">åŒä¼´è€…</h4><ul id="attr-companion" class="space-y-2"></ul></div>
                                <div class="tifo-card !shadow-none border p-4"><h4 class="text-md font-bold mb-3">å®¿æ³Šæ•°</h4><ul id="attr-stay" class="space-y-2"></ul></div>
                            </div>
                        </div>
                        <div id="ishikawa-detail-link-container" class="text-center mt-6 hidden"> <a href="https://codefornoto.github.io/TIFO/ishikawa/" target="_blank" rel="noopener noreferrer" class="tifo-button inline-block">è©³ç´°ãªåˆ†æã¯ã“ã¡ã‚‰</a> </div>
                    </div>
                    <div id="facility-prompt" class="pt-10"><p class="text-gray-500 text-center">æ–½è¨­ãƒ»ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="w-full p-4"> <div class="text-center"> <button id="about-button" class="text-sm text-gray-500 hover:underline">TIFOã¨ã¯</button> </div> </footer>
    <div id="about-modal" class="modal-overlay hidden"> <div class="modal-content"> <h2 class="text-2xl font-bold mb-4">TIFOã¨ã¯</h2> <div id="about-text" class="text-sm text-gray-600 leading-relaxed space-y-2"></div> <button id="close-about-modal-button" class="tifo-button mt-6 w-full">é–‰ã˜ã‚‹</button> </div> </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    let allSurveyData = { '3m': [], '1y': [], 'all': [] };
    // let allCommentData = []; // Removed
    let allFacilityLists = { '3m': {}, '1y': {}, 'all': {} };
    let currentPeriod = 'all';
    let currentPref = 'å¯Œå±±'; // Facility tab specific state
    let currentSurveyDataForRankings = []; // For ranking tabs (all prefectures)
    let currentFacilityList = []; // For facility tab (filtered by currentPref)
    let currentOverallTab = 'nps';

    const loadingIndicator = document.getElementById('loading-indicator');
    const appContainer = document.getElementById('app-container');

    const filterOptions = { /* çœç•¥ */
        age: ['10ä»£','20ä»£','30ä»£','40ä»£','50ä»£','60ä»£','70ä»£','80ä»£','90ä»£','100ä»£'], gender: ['ç”·', 'å¥³'], stay: ['æ—¥å¸°ã‚Š', '1æ³Š', '2æ³Š', '3æ³Š', '4æ³Šä»¥ä¸Š'], companion: ['è‡ªåˆ†ã²ã¨ã‚Š','æ‹äºº','å‹äºº','å¤«å©¦2äºº','å›£ä½“æ—…è¡Œ','è¦ªæˆš','è¦ª','è·å ´ã®åŒåƒš','å°å­¦ç”Ÿä»¥ä¸‹é€£ã‚Œã®å®¶æ—','ä¸­å­¦ç”Ÿä»¥ä¸‹é€£ã‚Œã®å®¶æ—','é«˜æ ¡ç”Ÿé€£ã‚Œã®å®¶æ—','ç½å®³æ”¯æ´'], purpose: ['å®¿ã§ã®ã‚“ã³ã‚Šéã”ã™','æ¸©æ³‰ã‚„éœ²å¤©é¢¨å‘‚','åœ°å…ƒã®ç¾å‘³ã—ã„ã‚‚ã®ã‚’é£Ÿã¹ã‚‹','èŠ±è¦‹ã‚„ç´…è‘‰ãªã©ã®è‡ªç„¶é‘‘è³','åæ‰€ã€æ—§è·¡ã®è¦³å…‰','ãƒ†ãƒ¼ãƒãƒ‘ãƒ¼ã‚¯ï¼ˆéŠåœ’åœ°ã€å‹•ç‰©åœ’ã€åšç‰©é¤¨ãªã©ï¼‰','è²·ã„ç‰©ã€ã‚¢ã‚¦ãƒˆãƒ¬ãƒƒãƒˆ','ãŠç¥­ã‚Šã‚„ã‚¤ãƒ™ãƒ³ãƒˆã¸ã®å‚åŠ ãƒ»è¦‹ç‰©','ã‚¹ãƒãƒ¼ãƒ„è¦³æˆ¦ã‚„èŠ¸èƒ½é‘‘è³ï¼ˆã‚³ãƒ³ã‚µãƒ¼ãƒˆç­‰ï¼‰','ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢ï¼ˆæµ·æ°´æµ´ã€é‡£ã‚Šã€ç™»å±±ãªã©ï¼‰','ã¾ã¡ã‚ã‚‹ãã€éƒ½å¸‚æ•£ç­–','å„ç¨®ä½“é¨“ï¼ˆæ‰‹ä½œã‚Šã€æœç‰©ç‹©ã‚Šãªã©ï¼‰','ã‚¹ã‚­ãƒ¼ãƒ»ã‚¹ãƒãƒœã€ãƒãƒªãƒ³ã‚¹ãƒãƒ¼ãƒ„','ãã®ä»–ã‚¹ãƒãƒ¼ãƒ„ï¼ˆã‚´ãƒ«ãƒ•ã€ãƒ†ãƒ‹ã‚¹ãªã©ï¼‰','ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ»ãƒ„ãƒ¼ãƒªãƒ³ã‚°','å‹äººãƒ»è¦ªæˆšã‚’å°‹ã­ã‚‹','å‡ºå¼µãªã©ä»•äº‹é–¢ä¿‚'], prefecture: ['åŒ—æµ·é“','é’æ£®çœŒ','å²©æ‰‹çœŒ','å®®åŸçœŒ','ç§‹ç”°çœŒ','å±±å½¢çœŒ','ç¦å³¶çœŒ','èŒ¨åŸçœŒ','æ ƒæœ¨çœŒ','ç¾¤é¦¬çœŒ','åŸ¼ç‰çœŒ','åƒè‘‰çœŒ','æ±äº¬éƒ½','ç¥å¥ˆå·çœŒ','æ–°æ½ŸçœŒ','å¯Œå±±çœŒ','çŸ³å·çœŒ','ç¦äº•çœŒ','å±±æ¢¨çœŒ','é•·é‡çœŒ','å²é˜œçœŒ','é™å²¡çœŒ','æ„›çŸ¥çœŒ','ä¸‰é‡çœŒ','æ»‹è³€çœŒ','äº¬éƒ½åºœ','å¤§é˜ªåºœ','å…µåº«çœŒ','å¥ˆè‰¯çœŒ','å’Œæ­Œå±±çœŒ','é³¥å–çœŒ','å³¶æ ¹çœŒ','å²¡å±±çœŒ','åºƒå³¶çœŒ','å±±å£çœŒ','å¾³å³¶çœŒ','é¦™å·çœŒ','æ„›åª›çœŒ','é«˜çŸ¥çœŒ','ç¦å²¡çœŒ','ä½è³€çœŒ','é•·å´çœŒ','ç†Šæœ¬çœŒ','å¤§åˆ†çœŒ','å®®å´çœŒ','é¹¿å…å³¶çœŒ','æ²–ç¸„çœŒ'], source: ['Facebook','Google','Googleãƒãƒƒãƒ—','Instagram','TikTok','Xï¼ˆæ—§Twitterï¼‰','YouTube','SNSåºƒå‘Š','ãƒ–ãƒ­ã‚°','ã¾ã¨ã‚ã‚µã‚¤ãƒˆ','ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆãƒ»ã‚¢ãƒ—ãƒª','ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ‹ãƒ¥ãƒ¼ã‚¹','å®¿æ³Šäºˆç´„Webã‚µã‚¤ãƒˆ','å®¿æ³Šæ–½è¨­','TVãƒ»ãƒ©ã‚¸ã‚ªç•ªçµ„ã‚„CM','ãƒ©ãƒ–ãƒ©ã‚¤ãƒ–ã®ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼','æ–°èãƒ»é›‘èªŒãƒ»ã‚¬ã‚¤ãƒ‰ãƒ–ãƒƒã‚¯','æ—…è¡Œä¼šç¤¾','å‹äººãƒ»çŸ¥äºº','åœ°å…ƒã®äºº','è¦³å…‰ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆãƒ»ãƒã‚¹ã‚¿ãƒ¼','è¦³å…‰æ¡ˆå†…æ‰€','è¦³å…‰å±•ãƒ»ç‰©ç”£å±•','è¦³å…‰é€£ç›Ÿã‚„DMOã®HP','ãã®ä»–'],
        // (MODIFIED) Income options based on prefecture
        income_default: ['100ä¸‡å††æœªæº€', '100ä¸‡å††ä»¥ä¸Š 200ä¸‡å††æœªæº€', '200ä¸‡å††ä»¥ä¸Š 300ä¸‡å††æœªæº€', '300ä¸‡å††ä»¥ä¸Š 400ä¸‡å††æœªæº€', '400ä¸‡å††ä»¥ä¸Š 500ä¸‡å††æœªæº€', '500ä¸‡å††ä»¥ä¸Š 600ä¸‡å††æœªæº€', '600ä¸‡å††ä»¥ä¸Š 700ä¸‡å††æœªæº€', '700ä¸‡å††ä»¥ä¸Š 800ä¸‡å††æœªæº€', '800ä¸‡å††ä»¥ä¸Š 900ä¸‡å††æœªæº€', '900ä¸‡å††ä»¥ä¸Š 1,000ä¸‡å††æœªæº€', '1,000ä¸‡å††ä»¥ä¸Š 1,200ä¸‡å††æœªæº€', '1,200ä¸‡å††ä»¥ä¸Š 1,500ä¸‡å††æœªæº€', '1,500ä¸‡å††ä»¥ä¸Š', 'åˆ†ã‹ã‚‰ãªã„/ç„¡å›ç­”'],
        income_toyama: ['1: 300ä¸‡å††æœªæº€', '2: 300ã€œ599ä¸‡å††', '3: 600ã€œ1000ä¸‡å††', '4: 1000ã€œ2000ä¸‡å††', '5: 2000ä¸‡å††ä»¥ä¸Š', '6: ç„¡å›ç­”']
    };
    // Add 'income' alias for default for easier access in segment ranking dropdown
    filterOptions['income'] = filterOptions['income_default'];

    const facilityAttributeCategories = { /* çœç•¥ */
        'age': { title: 'å¹´ä»£', columns: filterOptions.age, container: document.getElementById('attr-age') }, 'gender': { title: 'æ€§åˆ¥', columns: filterOptions.gender, container: document.getElementById('attr-gender') }, 'prefecture': { title: 'éƒ½é“åºœçœŒ', columns: filterOptions.prefecture, container: document.getElementById('attr-prefecture') }, 'purpose': { title: 'æ—…ã®ç›®çš„', columns: filterOptions.purpose, container: document.getElementById('attr-purpose') }, 'source': { title: 'æƒ…å ±æº', columns: filterOptions.source, container: document.getElementById('attr-source') }, 'income': { title: 'ä¸–å¸¯å¹´å', columns: [], container: document.getElementById('attr-income') }, // Columns set dynamically
         'companion': { title: 'åŒä¼´è€…', columns: filterOptions.companion, container: document.getElementById('attr-companion') }, 'stay': { title: 'å®¿æ³Šæ•°', columns: filterOptions.stay, container: document.getElementById('attr-stay') }
    };

    const parseCSV = (csvText) => { /* çœç•¥ */
        if (csvText.charCodeAt(0) === 0xFEFF) csvText = csvText.slice(1); const lines = csvText.trim().replace(/\r/g, '').split('\n'); if (lines.length < 2) return []; const csvRegex = /(?:^|,)(?:"([^"]*(?:""[^"]*)*)"|([^,]*))/g; const parseLine = (line) => { const values = []; let match; csvRegex.lastIndex = 0; while (match = csvRegex.exec(line)) values.push(match[1] ? match[1].replace(/""/g, '"') : match[2]); return values; }; const headers = parseLine(lines[0]).map(h => h.trim() === 'å›ç­”å ´æ‰€' ? 'æ–½è¨­' : h.trim()); return lines.slice(1).map(line => { if (!line.trim()) return null; const values = parseLine(line); const entry = {}; headers.forEach((header, index) => { const key = header; const rawValue = (values[index] || '').trim(); if (rawValue === '') entry[key] = null; else { const numValue = parseFloat(rawValue); entry[key] = !isNaN(numValue) ? numValue : rawValue; } }); entry['çœŒ'] = entry['TIF'] || null; return entry; }).filter(Boolean);
    };

    // (DELETED) parseTSV removed

    // (MODIFIED) initializeApp - remove TSV loading logic
    const initializeApp = async () => {
        try {
            // TSV loading removed
            const [csvAll, csv1y, csv3m] = await Promise.all([ fetch('./tifo_score_all.csv').then(res => res.text()), fetch('./tifo_score_1y.csv').then(res => res.text()), fetch('./tifo_score_3m.csv').then(res => res.text()) ]);
            allSurveyData['all'] = parseCSV(csvAll); allSurveyData['1y'] = parseCSV(csv1y); allSurveyData['3m'] = parseCSV(csv3m);
            if (allSurveyData['all'].length === 0) throw new Error('è¡¨ç¤ºå¯¾è±¡ã¨ãªã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆå…¨æœŸé–“ï¼‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            ['all', '1y', '3m'].forEach(period => {
                const list = { "å¯Œå±±": [], "çŸ³å·": [], "ç¦äº•": [] }; const filteredData = allSurveyData[period].filter(item => item['å›ç­”æ•°'] >= 30 && item['çœŒ']);
                filteredData.forEach(item => { if (list[item['çœŒ']] && item['æ–½è¨­']) list[item['çœŒ']].push(item['æ–½è¨­']); });
                list["å¯Œå±±"].sort(); list["çŸ³å·"].sort(); list["ç¦äº•"].sort(); allFacilityLists[period] = list;
            });
            updateCurrentData();
            loadingIndicator.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); appContainer.classList.remove('hidden');
            setupEventListeners();
            updateFacilityFilter(); // Initial draw for default selection (Toyama, All)
            handleDataFilterChange(); // Render initial tab content (Overall Ranking)

        } catch (error) { loadingIndicator.innerHTML = `<p class="text-red-500 font-bold">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p><p class="text-sm mt-2">${error.message}</p>`; console.error(error); }
    };

    const updateCurrentData = () => { /* çœç•¥ */
        currentSurveyDataForRankings = allSurveyData[currentPeriod].filter(d => d['å›ç­”æ•°'] >= 30); currentFacilityList = allFacilityLists[currentPeriod][currentPref] || [];
    };
    const updateFacilityFilter = () => { /* çœç•¥ */
        const facilityFilter = document.getElementById('facility-filter'); facilityFilter.innerHTML = '<option selected value="">æ–½è¨­ãƒ»ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„...</option>'; currentFacilityList.forEach(facilityName => { const opt = document.createElement('option'); opt.value = facilityName; opt.textContent = facilityName; facilityFilter.appendChild(opt); }); resetFacilityDetailView();
    };
    const resetFacilityDetailView = () => { /* çœç•¥ */
        document.getElementById('facility-scores').classList.add('hidden'); document.getElementById('facility-detail-wrapper').classList.add('hidden'); document.getElementById('facility-prompt').classList.remove('hidden'); const promptEl = document.getElementById('facility-prompt'); if (currentFacilityList.length === 0) promptEl.innerHTML = `<p class="text-gray-500 text-center pt-10">${currentPref}ã«ã¯ã“ã®æœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>`; else promptEl.innerHTML = '<p class="text-gray-500 text-center pt-10">æ–½è¨­ãƒ»ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>'; document.getElementById('ishikawa-detail-link-container').classList.add('hidden'); // Hide Ishikawa button on reset
    };
    const setupEventListeners = () => { /* çœç•¥ */
        const analysisBtn = document.getElementById('analysis-btn'); const analysisResults = document.getElementById('analysis-results'); const introSection = document.getElementById('intro-section'); const mainTabs = [{ btn: document.getElementById('main-tab-overall'), panel: document.getElementById('panel-overall') }, { btn: document.getElementById('main-tab-segment'), panel: document.getElementById('panel-segment') }, { btn: document.getElementById('main-tab-facility'), panel: document.getElementById('panel-facility') }]; const npsTab = document.getElementById('nps-tab'); const satisfactionTab = document.getElementById('satisfaction-tab'); const categoryFilter = document.getElementById('category-filter'); const detailFilter = document.getElementById('detail-filter'); const facilityFilter = document.getElementById('facility-filter'); const aboutButton = document.getElementById('about-button'); const aboutModal = document.getElementById('about-modal'); const closeAboutModalButton = document.getElementById('close-about-modal-button');
        analysisBtn.addEventListener('click', () => { analysisResults.classList.toggle('hidden'); if (analysisResults.classList.contains('hidden')) { introSection.classList.remove('mb-8'); appContainer.style.justifyContent = 'center'; } else { introSection.classList.add('mb-8'); appContainer.style.justifyContent = 'flex-start'; handleDataFilterChange(); } });
        mainTabs.forEach(tab => { tab.btn.addEventListener('click', () => { mainTabs.forEach(t => { t.btn.classList.remove('active'); t.panel.classList.remove('active'); }); tab.btn.classList.add('active'); tab.panel.classList.add('active'); handleDataFilterChange(); }); });
        document.querySelectorAll('#pref-selector .period-button').forEach(button => { button.addEventListener('click', (e) => { if (e.target.classList.contains('active')) return; currentPref = e.target.dataset.pref; document.querySelectorAll('#pref-selector .period-button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); handleDataFilterChange(); }); });
        document.querySelectorAll('.period-button-group[id^="period-selector-"]').forEach(group => { group.querySelectorAll('.period-button').forEach(button => { button.addEventListener('click', (e) => { if (e.target.classList.contains('active')) return; currentPeriod = e.target.dataset.period; document.querySelectorAll(`.period-button[data-period]`).forEach(btn => btn.classList.remove('active')); document.querySelectorAll(`.period-button[data-period="${currentPeriod}"]`).forEach(btn => btn.classList.add('active')); handleDataFilterChange(); }); }); });
        const handleDataFilterChange = () => { updateCurrentData(); const activeTabId = document.querySelector('.main-tab-button.active').id; if (activeTabId === 'main-tab-facility') updateFacilityFilter(); else if (activeTabId === 'main-tab-segment') { renderSegmentRanking(); categoryFilter.value = ""; detailFilter.innerHTML = '<option selected value="">è©³ç´°...</option>'; detailFilter.disabled = true; } else if (activeTabId === 'main-tab-overall') renderSimpleRanking(currentOverallTab); };
        npsTab.addEventListener('click', () => { if (currentOverallTab !== 'nps') { currentOverallTab = 'nps'; npsTab.classList.add('active'); satisfactionTab.classList.remove('active'); renderSimpleRanking('nps'); } }); satisfactionTab.addEventListener('click', () => { if (currentOverallTab !== 'satisfaction') { currentOverallTab = 'satisfaction'; satisfactionTab.classList.add('active'); npsTab.classList.remove('active'); renderSimpleRanking('satisfaction'); } });
        categoryFilter.addEventListener('change', () => { const selectedCategory = categoryFilter.value; detailFilter.innerHTML = '<option selected value="">è©³ç´°ã‚’é¸æŠ...</option>'; document.getElementById('segment-ranking-container').innerHTML = '<p class="text-gray-500 text-center pt-10">è©³ç´°...</p>'; if (selectedCategory) { filterOptions[selectedCategory].forEach(option => { const opt = document.createElement('option'); opt.value = option; opt.textContent = option; detailFilter.appendChild(opt); }); detailFilter.disabled = false; } else { detailFilter.disabled = true; document.getElementById('segment-ranking-container').innerHTML = '<p class="text-gray-500 text-center pt-10">åˆ†æè»¸...</p>'; } }); detailFilter.addEventListener('change', renderSegmentRanking); facilityFilter.addEventListener('change', () => renderFacilityDetail(facilityFilter.value));
        aboutButton.addEventListener('click', async () => { try { const res = await fetch('./aboutus.txt'); if (!res.ok) throw new Error(''); const txt = await res.text(); document.getElementById('about-text').innerHTML = txt.replace(/\n/g, '<br>'); aboutModal.classList.remove('hidden'); } catch (e) { document.getElementById('about-text').textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼å¤±æ•—'; aboutModal.classList.remove('hidden'); } }); closeAboutModalButton.addEventListener('click', () => aboutModal.classList.add('hidden')); aboutModal.addEventListener('click', (e) => { if (e.target === aboutModal) aboutModal.classList.add('hidden'); });
    };

    const createRankingCard = (rank, name, score, detailOrPref, unit = '') => { /* çœç•¥ */
        let rC='rank-default';if(rank===1)rC='rank-1';if(rank===2)rC='rank-2';if(rank===3)rC='rank-3';if(rank===4)rC='rank-4';if(rank===5)rC='rank-5';const pC={"å¯Œå±±":"pref-toyama","çŸ³å·":"pref-ishikawa","ç¦äº•":"pref-fukui"};let bH='';if(pC[detailOrPref])bH=`<span class="pref-badge ${pC[detailOrPref]}">${detailOrPref}</span>`;else bH=`<span class="pref-badge bg-gray-200 text-gray-700">${detailOrPref}</span>`;const sD=(typeof score==='number')?(unit==='ç‚¹'?score.toFixed(2):score.toFixed(1)):'N/A';return `<div class="flex items-center bg-white p-3 rounded-xl border border-gray-200 shadow-sm"><div class="rank-badge ${rC}">${rank}</div><div class="flex-grow ml-4 min-w-0"><p class="font-semibold text-gray-700 truncate" title="${name}">${name}</p><div class="mt-1">${bH}</div></div><div class="text-right flex-shrink-0 ml-2"><p class="text-2xl font-bold" style="color: var(--tifo-primary-dark);">${sD}<span class="text-sm text-gray-500 ml-1">${unit}</span></p></div></div>`;
    };
    const createAttributeRankingList = (topData) => { /* çœç•¥ */
        if(topData.length===0)return '<li class="text-gray-500 text-sm">ãƒ‡ãƒ¼ã‚¿ãªã—</li>';return topData.map(([key,percentage],index)=>{const pD=percentage.toFixed(1);let rC='rank-default';if(index===0)rC='rank-1';if(index===1)rC='rank-2';if(index===2)rC='rank-3';if(index===3)rC='rank-4';if(index===4)rC='rank-5';return `<li class="flex items-center text-sm"><span class="rank-badge !w-6 !h-6 !text-xs ${rC}">${index+1}</span><span class="ml-2 flex-1 text-gray-700 truncate" title="${key}">${key}</span><span class="font-bold w-16 text-right" style="color: var(--tifo-primary-dark);">${pD}%</span></li>`;}).join('');
    };

    // (DELETED) createCommentCard function removed

    const getSortableNPS = (value) => { if (typeof value !== 'number') return -Infinity; return Math.abs(value) <= 1 ? value * 100 : value; };
    const renderSimpleRanking = (type) => { /* çœç•¥ */
        const rC=document.getElementById('ranking-container');if(currentSurveyDataForRankings.length===0){rC.innerHTML=`<p class="text-gray-500 text-center pt-10">ã“ã®æ¡ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;return;}const sK=type==='nps'?'NPS':'æº€è¶³åº¦ï¼ˆæ—…è¡Œå…¨ä½“ï¼‰';const sD=[...currentSurveyDataForRankings].sort((a,b)=>{const vA=type==='nps'?getSortableNPS(a[sK]):(a[sK]||-Infinity);const vB=type==='nps'?getSortableNPS(b[sK]):(b[sK]||-Infinity);return vB-vA;});rC.innerHTML=sD.map((item,index)=>{const sV=item[sK];const score=type==='nps'?getSortableNPS(sV):sV;return createRankingCard(index+1,item['æ–½è¨­'],score,item['çœŒ'],type==='satisfaction'?'ç‚¹':'');}).join('');
    };
    const renderSegmentRanking = () => { /* çœç•¥: Calculation correct now */
        const sRC=document.getElementById('segment-ranking-container');const fV=document.getElementById('detail-filter').value;if(currentSurveyDataForRankings.length===0){sRC.innerHTML=`<p class="text-gray-500 text-center pt-10">ã“ã®æ¡ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;return;}if(!fV){sRC.innerHTML='<p class="text-gray-500 text-center pt-10">è©³ç´°ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>';return;}const cD=currentSurveyDataForRankings.map(item=>{const count=item[fV];const total=item['å›ç­”æ•°'];const percentage=(typeof count==='number'&&total>0)?(count/total)*100:-1;return{...item,percentage:percentage};}).sort((a,b)=>b.percentage-a.percentage);sRC.innerHTML=cD.map((item,index)=>{const score=item.percentage<0?'N/A':item.percentage;return createRankingCard(index+1,item['æ–½è¨­'],score,item['çœŒ'],'%');}).join('');
    };

    // (MODIFIED) Render Facility Detail Function
    const renderFacilityDetail = (facilityName) => {
        const scoresContainer = document.getElementById('facility-scores'); const detailWrapper = document.getElementById('facility-detail-wrapper'); const prompt = document.getElementById('facility-prompt'); const ishikawaLinkContainer = document.getElementById('ishikawa-detail-link-container'); // Get Ishikawa button container
        // (DELETED) commentsContainer removed
        if (!facilityName) { resetFacilityDetailView(); return; }
        const facilityData = allSurveyData[currentPeriod].find(item => item['æ–½è¨­'] === facilityName && item['çœŒ'] === currentPref);
        if (!facilityData || facilityData['å›ç­”æ•°'] < 30) { resetFacilityDetailView(); prompt.innerHTML = '<p class="text-red-500 text-center pt-10">ã“ã®æ–½è¨­ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€å›ç­”æ•°ãŒ30æœªæº€ã§ã™ã€‚</p>'; return; }
        scoresContainer.classList.remove('hidden'); detailWrapper.classList.remove('hidden'); prompt.classList.add('hidden');

        // --- 1. NPSã¨æº€è¶³åº¦ã‚²ãƒ¼ã‚¸ ---
        const npsRaw = facilityData['NPS']; const npsScore = npsRaw !== null && npsRaw !== undefined ? getSortableNPS(npsRaw).toFixed(1) : 'N/A'; document.getElementById('facility-nps-score').textContent = npsScore; const normalizedNpsPercent = npsScore !== 'N/A' ? (Number(npsScore) + 100) / 2 : 50; document.getElementById('facility-nps-bar').style.left = `calc(${normalizedNpsPercent}% - 0.375rem)`;
        const satisfaction = facilityData['æº€è¶³åº¦ï¼ˆæ—…è¡Œå…¨ä½“ï¼‰']; const satisfactionScore = (satisfaction && !isNaN(satisfaction)) ? Number(satisfaction) : 0; document.getElementById('facility-satisfaction-score').textContent = satisfactionScore.toFixed(1); document.getElementById('facility-satisfaction-bar').style.width = `${(satisfactionScore / 5) * 100}%`;

        // --- 2. å±æ€§TOP5 ---
        const totalAnswers = facilityData['å›ç­”æ•°'];
        for (const categoryKey in facilityAttributeCategories) {
            const category = facilityAttributeCategories[categoryKey]; let segments = [];
            // (MODIFIED) Dynamically set income columns based on prefecture
            let incomeColumns = (currentPref === 'å¯Œå±±') ? filterOptions.income_toyama : filterOptions.income_default;
            let columnsToUse = (categoryKey === 'income') ? incomeColumns : category.columns;

            columnsToUse.forEach(colName => {
                if (facilityData.hasOwnProperty(colName)) {
                    const count = facilityData[colName]; // Assume count
                    if (typeof count === 'number' && count > 0 && totalAnswers > 0) {
                        const percentage = (count / totalAnswers) * 100; segments.push([colName, percentage]);
                    }
                }
            });
            segments.sort((a, b) => b[1] - a[1]); const top5Segments = segments.slice(0, 5);
            if (category.container) category.container.innerHTML = createAttributeRankingList(top5Segments);
            else console.error(`Container not found for category: ${categoryKey}`);
        }

        // --- 3. (DELETED) è‡ªç”±è¨˜è¿°ã‚³ãƒ¡ãƒ³ãƒˆã®æç”»ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤ ---

        // --- 4. çŸ³å·çœŒè©³ç´°ãƒªãƒ³ã‚¯ã®è¡¨ç¤ºåˆ¶å¾¡ ---
        if (currentPref === 'çŸ³å·') ishikawaLinkContainer.classList.remove('hidden');
        else ishikawaLinkContainer.classList.add('hidden');
    };

    initializeApp();
});
</script>

</body>
</html>
